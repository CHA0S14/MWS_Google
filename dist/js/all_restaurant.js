class DBHelper{static get DATABASE_URL(){return"http://localhost:1337/restaurants"}static get REVIEW_URL(){return"http://localhost:1337/reviews/?restaurant_id="}static getRestaurantFromApi(e,t){fetch(e).then(e=>e.json()).then(e=>{if(void 0!==DBHelper.db){var n=DBHelper.db.transaction(["restaurants"],"readwrite").objectStore("restaurants");if(Array.isArray(e))for(var r in e){n.put(e[r]).onerror=(()=>{console.log("Couldnt be added")})}else n.put(e).onerror=(()=>{console.log("Couldnt be added")})}t(null,e)}).catch(e=>{t(`Request failed. ${e}`,null)})}static getReviewsFromApi(e,t){fetch(e).then(e=>e.json()).then(e=>{if(void 0!==DBHelper.db2){var n=DBHelper.db2.transaction(["reviews"],"readwrite").objectStore("reviews");if(Array.isArray(e))for(var r in e){delete e[r].id,n.put(e[r]).onerror=(()=>{console.log("Couldnt be added")})}else delete e.id,n.put(e).onerror=(()=>{console.log("Couldnt be added")})}t(null,e)}).catch(e=>{t(`Request failed. ${e}`,null)})}static fetchRestaurantById(e,t){var n=DBHelper.DATABASE_URL+`/${e}`;if(void 0!==DBHelper.db){var r=DBHelper.db.transaction(["restaurants"]).objectStore("restaurants").get(parseInt(e));r.onsuccess=function(e){void 0===r.result?t("No restaurant found",null):t(null,r.result)},r.onerror=function(e){}}DBHelper.getRestaurantFromApi(n,t)}static fetchReviewRestaurantById(e,t){var n=DBHelper.REVIEW_URL+`${e}`;if(void 0!==DBHelper.db2){var r=DBHelper.db2.transaction(["reviews"]).objectStore("reviews").index("restaurant_id").getAll(parseInt(e));r.onsuccess=function(e){if(void 0===r.result)t("No restaurant found",null),DBHelper.getFromApi(n,t);else{var a=r.result;t(null,r.result),DBHelper.getReviewsFromApi(n,(e,n)=>{var o=new Worker("./js/updaterReviewApiWorker.js"),i=[a,n];o.postMessage(i),r.result||t(e,n)})}},r.onerror=function(e){DBHelper.getReviewsFromApi(n,t)}}}static urlForRestaurant(e){return`./restaurant.html?id=${e.id}`}static imageUrlForRestaurant(e){return`/img/${e.photograph}.jpg`}static mapMarkerForRestaurant(e,t){return new google.maps.Marker({position:e.latlng,title:e.name,url:DBHelper.urlForRestaurant(e),map:t,animation:google.maps.Animation.DROP})}}let restaurant,reviews;var map;const MAX_TEXT_LENGTH=400;function registerSW(){var e;navigator.serviceWorker&&(navigator.serviceWorker.register("sw.js").then(function(e){navigator.serviceWorker.controller&&(e.waiting?updateReady(e.waiting):e.installing?trackInstalling(e.installing):e.addEventListener("updatefound",function(){trackInstalling(e.installing)}))}),navigator.serviceWorker.addEventListener("controllerchange",function(){e||(window.location.reload(),e=!0)}))}window.initMap=(()=>{window.indexedDB||window.mozIndexedDB||window.webkitIndexedDB||window.msIndexedDB||window.shimIndexedDB;window.indexedDB||(window.alert("Su navegador no soporta una versión estable de indexedDB. Tal y como las características no serán validas"),fetchRestaurantFromURL((e,t)=>{e?console.error(e):(self.map=new google.maps.Map(document.getElementById("map"),{zoom:16,center:t.latlng,scrollwheel:!1}),fillBreadcrumb(),DBHelper.mapMarkerForRestaurant(self.restaurant,self.map))}));let e=window.indexedDB.open("restaurants-json",1);e.onerror=function(e){alert("Why didn't you allow my web app to use IndexedDB?!")},e.onsuccess=function(t){DBHelper.db=e.result,fetchRestaurantFromURL((e,t)=>{e?console.error(e):(self.map=new google.maps.Map(document.getElementById("map"),{zoom:16,center:t.latlng,scrollwheel:!1}),fillBreadcrumb(),DBHelper.mapMarkerForRestaurant(self.restaurant,self.map))}),DBHelper.db.onerror=function(e){alert("Database error: "+e.target.errorCode)}},e.onupgradeneeded=function(e){var t=e.target.result.createObjectStore("restaurants",{keyPath:"id"});t.createIndex("neighborhood","neighborhood",{unique:!1}),t.createIndex("cuisine_type","cuisine_type",{unique:!1}),t.createIndex("neighborhood-cuisine_type",["neighborhood","cuisine_type"],{unique:!1})};let t=window.indexedDB.open("reviews-json",1);t.onerror=function(e){alert("Why didn't you allow my web app to use IndexedDB?!")},t.onsuccess=function(e){DBHelper.db2=t.result,fetchReviewsFromURL(),DBHelper.db2.onerror=function(e){alert("Database error: "+e.target.errorCode)}},t.onupgradeneeded=function(e){e.target.result.createObjectStore("reviews",{keyPath:["restaurant_id","name","createdAt","updatedAt"]}).createIndex("restaurant_id","restaurant_id",{unique:!1})},document.getElementById("review-form").addEventListener("click",function(e){e.preventDefault();var t=new Worker("./js/postWorker.js"),n=document.getElementsByName("username")[0].value;document.getElementsByName("username")[0].value=null;var r=document.getElementsByName("rating")[0].value;document.getElementsByName("rating")[0].value=null;var a=document.getElementsByName("comment")[0].value;document.getElementsByName("comment")[0].value=null;var o=getParameterByName("id"),i={restaurant_id:parseInt(o),name:n,createdAt:Date.now(),updatedAt:Date.now(),rating:r,comments:a};t.postMessage(i),addReview(i)}),document.getElementById("show-map-link").addEventListener("click",e=>{e.preventDefault(),"Show Map"===e.target.innerHTML?(document.getElementById("map").style.display="block",e.target.innerHTML="Hidde Map"):(document.getElementById("map").style.display="none",e.target.innerHTML="Show Map")})}),addReview=(e=>{(document.getElementById("reviews-list").appendChild(createReviewHTML(e)),void 0!==DBHelper.db2)&&(DBHelper.db2.transaction(["reviews"],"readwrite").objectStore("reviews").put(e).onerror=(()=>{console.log("Couldnt be added")}))}),fetchRestaurantFromURL=(e=>{if(self.restaurant)e(null,self.restaurant);else{var t=getParameterByName("id");t?DBHelper.fetchRestaurantById(t,(t,n)=>{self.restaurant=n,n?(fillRestaurantHTML(),e(null,n)):console.error(t)}):(error="No restaurant id in URL",e(error,null))}}),fetchReviewsFromURL=(e=>{if(self.review)e(null,self.review);else{var t=getParameterByName("id");t?DBHelper.fetchReviewRestaurantById(t,(e,t)=>{self.reviews=t,t?fillReviewsHTML():console.error(e)}):(error="No restaurant id in URL",e(error,null))}}),fillRestaurantHTML=((e=self.restaurant)=>{document.getElementById("restaurant-name").innerHTML=e.name,document.getElementById("restaurant-address").innerHTML=e.address;const t=document.getElementById("restaurant-img");t.className="restaurant-img",t.src=DBHelper.imageUrlForRestaurant(e),t.alt=e.name+"'s image showing some delicius "+e.cuisine_type+" food coocked in "+e.neighborhood,document.getElementById("restaurant-cuisine").innerHTML=e.cuisine_type,e.operating_hours&&fillRestaurantHoursHTML()}),fillRestaurantHoursHTML=((e=self.restaurant.operating_hours)=>{const t=document.getElementById("restaurant-hours");for(let n in e){const r=document.createElement("tr"),a=document.createElement("td");a.innerHTML=n,r.appendChild(a);const o=document.createElement("td");o.innerHTML=e[n],r.appendChild(o),t.appendChild(r)}}),fillReviewsHTML=((e=self.reviews)=>{const t=document.getElementById("reviews-container");if(!e){const e=document.createElement("p");return e.innerHTML="No reviews yet!",void t.appendChild(e)}const n=document.getElementById("reviews-list");e.forEach(e=>{n.appendChild(createReviewHTML(e))}),t.appendChild(n)}),createReviewHTML=(e=>{const t=document.createElement("li"),n=document.createElement("div");n.setAttribute("class","title-date-div flex-container");const r=document.createElement("p");r.innerHTML=e.name,r.setAttribute("class","review-title"),n.appendChild(r);const a=document.createElement("p");a.innerHTML=new Date(e.updatedAt).toUTCString(),a.setAttribute("class","review-date"),n.appendChild(a),t.appendChild(n);const o=document.createElement("div");o.setAttribute("class","rating-comment-div");const i=document.createElement("p");i.innerHTML=`Rating: ${e.rating}`,i.setAttribute("class","review-rating"),o.appendChild(i);const s=document.createElement("div");if(e.comments.length>400){const t=e.comments.substring(0,400)+"...",n=document.createElement("p");n.setAttribute("class","review-snipet"),n.innerHTML=t,s.appendChild(n)}const l=document.createElement("p");if(l.innerHTML=e.comments,l.setAttribute("class","review-text"),e.comments.length>400&&(l.style.display="none"),s.appendChild(l),e.comments.length>400){const e=document.createElement("button");e.innerHTML="See more...",e.setAttribute("class","display-button"),e.addEventListener("click",function(){"See more..."===this.innerHTML?(this.innerHTML="See less...",this.previousElementSibling.style.display="block",this.previousElementSibling.previousElementSibling.style.display="none"):(this.innerHTML="See more...",this.previousElementSibling.style.display="none",this.previousElementSibling.previousElementSibling.style.display="block")}),s.appendChild(e)}return o.appendChild(s),t.appendChild(o),t}),fillBreadcrumb=((e=self.restaurant)=>{const t=document.getElementById("breadcrumb"),n=document.createElement("li");n.innerHTML=e.name,t.appendChild(n)}),getParameterByName=((e,t)=>{t||(t=window.location.href),e=e.replace(/[\[\]]/g,"\\$&");const n=new RegExp(`[?&]${e}(=([^&#]*)|&|#|$)`).exec(t);return n?n[2]?decodeURIComponent(n[2].replace(/\+/g," ")):"":null}),updateReady=function(e){e.postMessage({action:"skipWaiting"})},trackInstalling=function(e){e.addEventListener("statechange",function(){"installed"==e.state&&updateReady(e)})};
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImRiaGVscGVyX3Jlc3RhdXJhbnQuanMiLCJyZXN0YXVyYW50X2luZm8uanMiLCJzd1JlZ2lzdGVyLmpzIl0sIm5hbWVzIjpbIkRCSGVscGVyIiwiREFUQUJBU0VfVVJMIiwiUkVWSUVXX1VSTCIsIltvYmplY3QgT2JqZWN0XSIsInVybCIsImNhbGxiYWNrIiwiZmV0Y2giLCJ0aGVuIiwicmVzcG9uc2UiLCJqc29uIiwidW5kZWZpbmVkIiwiZGIiLCJvYmplY3RTdG9yZSIsInRyYW5zYWN0aW9uIiwiQXJyYXkiLCJpc0FycmF5IiwiaSIsInB1dCIsIm9uZXJyb3IiLCJjb25zb2xlIiwibG9nIiwiY2F0Y2giLCJlIiwiZGIyIiwiaWQiLCJyZXF1ZXN0IiwiZ2V0IiwicGFyc2VJbnQiLCJvbnN1Y2Nlc3MiLCJldmVudCIsInJlc3VsdCIsImdldFJlc3RhdXJhbnRGcm9tQXBpIiwiaW5kZXgiLCJnZXRBbGwiLCJnZXRGcm9tQXBpIiwiY2FjaGVSZXZpZXdzIiwiZ2V0UmV2aWV3c0Zyb21BcGkiLCJlcnJvciIsIndvcmtlciIsIldvcmtlciIsIm1lc3NhZ2UiLCJwb3N0TWVzc2FnZSIsInJlc3RhdXJhbnQiLCJwaG90b2dyYXBoIiwibWFwIiwiZ29vZ2xlIiwibWFwcyIsIk1hcmtlciIsInBvc2l0aW9uIiwibGF0bG5nIiwidGl0bGUiLCJuYW1lIiwidXJsRm9yUmVzdGF1cmFudCIsImFuaW1hdGlvbiIsIkFuaW1hdGlvbiIsIkRST1AiLCJyZXZpZXdzIiwiTUFYX1RFWFRfTEVOR1RIIiwicmVnaXN0ZXJTVyIsInJlZnJlc2hpbmciLCJuYXZpZ2F0b3IiLCJzZXJ2aWNlV29ya2VyIiwicmVnaXN0ZXIiLCJyZWciLCJjb250cm9sbGVyIiwid2FpdGluZyIsInVwZGF0ZVJlYWR5IiwiaW5zdGFsbGluZyIsInRyYWNrSW5zdGFsbGluZyIsImFkZEV2ZW50TGlzdGVuZXIiLCJ3aW5kb3ciLCJsb2NhdGlvbiIsInJlbG9hZCIsImluaXRNYXAiLCJpbmRleGVkREIiLCJtb3pJbmRleGVkREIiLCJ3ZWJraXRJbmRleGVkREIiLCJtc0luZGV4ZWREQiIsInNoaW1JbmRleGVkREIiLCJhbGVydCIsImZldGNoUmVzdGF1cmFudEZyb21VUkwiLCJzZWxmIiwiTWFwIiwiZG9jdW1lbnQiLCJnZXRFbGVtZW50QnlJZCIsInpvb20iLCJjZW50ZXIiLCJzY3JvbGx3aGVlbCIsImZpbGxCcmVhZGNydW1iIiwibWFwTWFya2VyRm9yUmVzdGF1cmFudCIsIm9wZW4iLCJ0YXJnZXQiLCJlcnJvckNvZGUiLCJvbnVwZ3JhZGVuZWVkZWQiLCJjcmVhdGVPYmplY3RTdG9yZSIsImtleVBhdGgiLCJjcmVhdGVJbmRleCIsInVuaXF1ZSIsInJlcXVlc3QyIiwiZmV0Y2hSZXZpZXdzRnJvbVVSTCIsInByZXZlbnREZWZhdWx0IiwidXNlcm5hbWUiLCJnZXRFbGVtZW50c0J5TmFtZSIsInZhbHVlIiwicmF0aW5nIiwiY29tbWVudCIsImdldFBhcmFtZXRlckJ5TmFtZSIsInJlc3RhdXJhbnRfaWQiLCJjcmVhdGVkQXQiLCJEYXRlIiwibm93IiwidXBkYXRlZEF0IiwiY29tbWVudHMiLCJhZGRSZXZpZXciLCJpbm5lckhUTUwiLCJzdHlsZSIsImRpc3BsYXkiLCJhcHBlbmRDaGlsZCIsImNyZWF0ZVJldmlld0hUTUwiLCJmZXRjaFJlc3RhdXJhbnRCeUlkIiwiZmlsbFJlc3RhdXJhbnRIVE1MIiwicmV2aWV3IiwiZmV0Y2hSZXZpZXdSZXN0YXVyYW50QnlJZCIsImZpbGxSZXZpZXdzSFRNTCIsImFkZHJlc3MiLCJpbWFnZSIsImNsYXNzTmFtZSIsInNyYyIsImltYWdlVXJsRm9yUmVzdGF1cmFudCIsImFsdCIsImN1aXNpbmVfdHlwZSIsIm5laWdoYm9yaG9vZCIsIm9wZXJhdGluZ19ob3VycyIsImZpbGxSZXN0YXVyYW50SG91cnNIVE1MIiwib3BlcmF0aW5nSG91cnMiLCJob3VycyIsImtleSIsInJvdyIsImNyZWF0ZUVsZW1lbnQiLCJkYXkiLCJ0aW1lIiwiY29udGFpbmVyIiwibm9SZXZpZXdzIiwidWwiLCJmb3JFYWNoIiwibGkiLCJkaXZOYW1lRGF0ZSIsInNldEF0dHJpYnV0ZSIsImRhdGUiLCJ0b1VUQ1N0cmluZyIsImRpdlJhdGluZ0NvbW1lbnRzIiwiY29tbWVudERpdiIsImxlbmd0aCIsInNuaXBldFRleHQiLCJzdWJzdHJpbmciLCJzbmlwZXQiLCJkaXNwbGF5QnV0dG9uIiwidGhpcyIsInByZXZpb3VzRWxlbWVudFNpYmxpbmciLCJicmVhZGNydW1iIiwiaHJlZiIsInJlcGxhY2UiLCJyZXN1bHRzIiwiUmVnRXhwIiwiZXhlYyIsImRlY29kZVVSSUNvbXBvbmVudCIsImFjdGlvbiIsInN0YXRlIl0sIm1hcHBpbmdzIjoiTUFHQUEsU0FLQUMsMEJBRUEsTUFBQSxvQ0FFQUMsd0JBRUEsTUFBQSxnREFHQUMsNEJBQUFDLEVBQUFDLEdBQ0FDLE1BQUFGLEdBQ0FHLEtBQUFDLEdBQUFBLEVBQUFDLFFBQ0FGLEtBQUFDLElBRUEsUUFBQUUsSUFBQVYsU0FBQVcsR0FBQSxDQUNBLElBQ0FDLEVBREFaLFNBQUFXLEdBQUFFLGFBQUEsZUFBQSxhQUNBRCxZQUFBLGVBRUEsR0FBQUUsTUFBQUMsUUFBQVAsR0FDQSxJQUFBLElBQUFRLEtBQUFSLEVBQUEsQ0FDQUksRUFBQUssSUFBQVQsRUFBQVEsSUFDQUUsUUFBQSxNQUNBQyxRQUFBQyxJQUFBLDJCQUlBUixFQUFBSyxJQUFBVCxHQUNBVSxRQUFBLE1BQ0FDLFFBQUFDLElBQUEsc0JBS0FmLEVBQUEsS0FBQUcsS0FFQWEsTUFBQUMsSUFFQWpCLHFCQURBaUIsSUFDQSxRQUlBbkIseUJBQUFDLEVBQUFDLEdBQ0FDLE1BQUFGLEdBQ0FHLEtBQUFDLEdBQUFBLEVBQUFDLFFBQ0FGLEtBQUFDLElBRUEsUUFBQUUsSUFBQVYsU0FBQXVCLElBQUEsQ0FDQSxJQUNBWCxFQURBWixTQUFBdUIsSUFBQVYsYUFBQSxXQUFBLGFBQ0FELFlBQUEsV0FFQSxHQUFBRSxNQUFBQyxRQUFBUCxHQUNBLElBQUEsSUFBQVEsS0FBQVIsRUFBQSxRQUNBQSxFQUFBUSxH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QUFBQyxTQUFBeUYsTUFDQTdHLEVBQUFBLEVBQUE4RyxRQUFBLFVBQUEsUUFDQSxNQUNBQyxFQURBLElBQUFDLGNBQUFoSCxzQkFDQWlILEtBQUFoSyxHQUNBLE9BQUE4SixFQUVBQSxFQUFBLEdBRUFHLG1CQUFBSCxFQUFBLEdBQUFELFFBQUEsTUFBQSxNQURBLEdBRkEsT0M3VkEvRixZQUFBLFNBQUE1QixHQUNBQSxFQUFBRyxhQUFBNkgsT0FBQSxpQkFHQWxHLGdCQUFBLFNBQUE5QixHQUNBQSxFQUFBK0IsaUJBQUEsY0FBQSxXQUNBLGFBQUEvQixFQUFBaUksT0FDQXJHLFlBQUE1QiIsImZpbGUiOiJhbGxfcmVzdGF1cmFudC5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8qKiBcclxuICogQ29tbW9uIGRhdGFiYXNlIGhlbHBlciBmdW5jdGlvbnMuXHJcbiAqL1xyXG5jbGFzcyBEQkhlbHBlciB7XHJcbiAgLyoqXHJcbiAgICogRGF0YWJhc2UgVVJMLlxyXG4gICAqIENoYW5nZSB0aGlzIHRvIHJlc3RhdXJhbnRzLmpzb24gZmlsZSBsb2NhdGlvbiBvbiB5b3VyIHNlcnZlci5cclxuICAgKi9cclxuICBzdGF0aWMgZ2V0IERBVEFCQVNFX1VSTCgpIHtcclxuICAgIGNvbnN0IHBvcnQgPSAxMzM3OyAvLyBDaGFuZ2UgdGhpcyB0byB5b3VyIHNlcnZlciBwb3J0XHJcbiAgICByZXR1cm4gYGh0dHA6Ly9sb2NhbGhvc3Q6JHtwb3J0fS9yZXN0YXVyYW50c2A7XHJcbiAgfVxyXG4gIHN0YXRpYyBnZXQgUkVWSUVXX1VSTCgpIHtcclxuICAgIGNvbnN0IHBvcnQgPSAxMzM3OyAvLyBDaGFuZ2UgdGhpcyB0byB5b3VyIHNlcnZlciBwb3J0XHJcbiAgICByZXR1cm4gYGh0dHA6Ly9sb2NhbGhvc3Q6JHtwb3J0fS9yZXZpZXdzLz9yZXN0YXVyYW50X2lkPWA7XHJcbiAgfVxyXG5cclxuICBzdGF0aWMgZ2V0UmVzdGF1cmFudEZyb21BcGkodXJsLCBjYWxsYmFjaykge1xyXG4gICAgdmFyIHJlc3RhdXJhbnREYXRhID0gZmV0Y2godXJsKVxyXG4gICAgICAudGhlbigocmVzcG9uc2UpID0+IHJlc3BvbnNlLmpzb24oKSlcclxuICAgICAgLnRoZW4oKHJlc3BvbnNlKSA9PiB7XHJcblxyXG4gICAgICAgIGlmIChEQkhlbHBlci5kYiAhPT0gdW5kZWZpbmVkKSB7XHJcbiAgICAgICAgICB2YXIgdHJhbnNhY3Rpb24gPSBEQkhlbHBlci5kYi50cmFuc2FjdGlvbihbXCJyZXN0YXVyYW50c1wiXSwgXCJyZWFkd3JpdGVcIik7XHJcbiAgICAgICAgICB2YXIgb2JqZWN0U3RvcmUgPSB0cmFuc2FjdGlvbi5vYmplY3RTdG9yZShcInJlc3RhdXJhbnRzXCIpO1xyXG5cclxuICAgICAgICAgIGlmIChBcnJheS5pc0FycmF5KHJlc3BvbnNlKSkge1xyXG4gICAgICAgICAgICBmb3IgKHZhciBpIGluIHJlc3BvbnNlKSB7XHJcbiAgICAgICAgICAgICAgdmFyIHJlcXVlc3QgPSBvYmplY3RTdG9yZS5wdXQocmVzcG9uc2VbaV0pO1xyXG4gICAgICAgICAgICAgIHJlcXVlc3Qub25lcnJvciA9ICgpID0+IHtcclxuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiQ291bGRudCBiZSBhZGRlZFwiKVxyXG4gICAgICAgICAgICAgIH07XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIHZhciByZXF1ZXN0ID0gb2JqZWN0U3RvcmUucHV0KHJlc3BvbnNlKTtcclxuICAgICAgICAgICAgcmVxdWVzdC5vbmVycm9yID0gKCkgPT4ge1xyXG4gICAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiQ291bGRudCBiZSBhZGRlZFwiKVxyXG4gICAgICAgICAgICB9O1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgY2FsbGJhY2sobnVsbCwgcmVzcG9uc2UpO1xyXG4gICAgICB9KVxyXG4gICAgICAuY2F0Y2goKGUpID0+IHtcclxuICAgICAgICBjb25zdCBlcnJvciA9IChgUmVxdWVzdCBmYWlsZWQuICR7ZX1gKTtcclxuICAgICAgICBjYWxsYmFjayhlcnJvciwgbnVsbCk7XHJcbiAgICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgc3RhdGljIGdldFJldmlld3NGcm9tQXBpKHVybCwgY2FsbGJhY2spIHtcclxuICAgIHZhciByZXN0YXVyYW50RGF0YSA9IGZldGNoKHVybClcclxuICAgICAgLnRoZW4oKHJlc3BvbnNlKSA9PiByZXNwb25zZS5qc29uKCkpXHJcbiAgICAgIC50aGVuKChyZXNwb25zZSkgPT4ge1xyXG5cclxuICAgICAgICBpZiAoREJIZWxwZXIuZGIyICE9PSB1bmRlZmluZWQpIHtcclxuICAgICAgICAgIHZhciB0cmFuc2FjdGlvbiA9IERCSGVscGVyLmRiMi50cmFuc2FjdGlvbihbXCJyZXZpZXdzXCJdLCBcInJlYWR3cml0ZVwiKTtcclxuICAgICAgICAgIHZhciBvYmplY3RTdG9yZSA9IHRyYW5zYWN0aW9uLm9iamVjdFN0b3JlKFwicmV2aWV3c1wiKTtcclxuXHJcbiAgICAgICAgICBpZiAoQXJyYXkuaXNBcnJheShyZXNwb25zZSkpIHtcclxuICAgICAgICAgICAgZm9yICh2YXIgaSBpbiByZXNwb25zZSkge1xyXG4gICAgICAgICAgICAgIGRlbGV0ZSByZXNwb25zZVtpXS5pZDtcclxuICAgICAgICAgICAgICB2YXIgcmVxdWVzdCA9IG9iamVjdFN0b3JlLnB1dChyZXNwb25zZVtpXSk7XHJcbiAgICAgICAgICAgICAgcmVxdWVzdC5vbmVycm9yID0gKCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coXCJDb3VsZG50IGJlIGFkZGVkXCIpXHJcbiAgICAgICAgICAgICAgfTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgZGVsZXRlIHJlc3BvbnNlLmlkO1xyXG4gICAgICAgICAgICB2YXIgcmVxdWVzdCA9IG9iamVjdFN0b3JlLnB1dChyZXNwb25zZSk7XHJcbiAgICAgICAgICAgIHJlcXVlc3Qub25lcnJvciA9ICgpID0+IHtcclxuICAgICAgICAgICAgICBjb25zb2xlLmxvZyhcIkNvdWxkbnQgYmUgYWRkZWRcIilcclxuICAgICAgICAgICAgfTtcclxuICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgY2FsbGJhY2sobnVsbCwgcmVzcG9uc2UpO1xyXG4gICAgICB9KVxyXG4gICAgICAuY2F0Y2goKGUpID0+IHtcclxuICAgICAgICBjb25zdCBlcnJvciA9IChgUmVxdWVzdCBmYWlsZWQuICR7ZX1gKTtcclxuICAgICAgICBjYWxsYmFjayhlcnJvciwgbnVsbCk7XHJcbiAgICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogRmV0Y2ggYSByZXN0YXVyYW50IGJ5IGl0cyBJRC5cclxuICAgKi9cclxuICBzdGF0aWMgZmV0Y2hSZXN0YXVyYW50QnlJZChpZCwgY2FsbGJhY2spIHtcclxuICAgIHZhciB1cmwgPSBEQkhlbHBlci5EQVRBQkFTRV9VUkwgKyBgLyR7aWR9YDtcclxuICAgIGlmIChEQkhlbHBlci5kYiAhPT0gdW5kZWZpbmVkKSB7XHJcbiAgICAgIHZhciB0cmFuc2FjdGlvbiA9IERCSGVscGVyLmRiLnRyYW5zYWN0aW9uKFtcInJlc3RhdXJhbnRzXCJdKTtcclxuICAgICAgdmFyIG9iamVjdFN0b3JlID0gdHJhbnNhY3Rpb24ub2JqZWN0U3RvcmUoXCJyZXN0YXVyYW50c1wiKTtcclxuICAgICAgdmFyIHJlcXVlc3QgPSBvYmplY3RTdG9yZS5nZXQocGFyc2VJbnQoaWQpKTtcclxuXHJcbiAgICAgIHJlcXVlc3Qub25zdWNjZXNzID0gZnVuY3Rpb24oZXZlbnQpIHtcclxuXHJcbiAgICAgICAgaWYocmVxdWVzdC5yZXN1bHQgPT09IHVuZGVmaW5lZCl7XHJcbiAgICAgICAgICBjYWxsYmFjayhcIk5vIHJlc3RhdXJhbnQgZm91bmRcIiwgbnVsbCk7XHJcbiAgICAgICAgfWVsc2V7XHJcbiAgICAgICAgICBjYWxsYmFjayhudWxsLCByZXF1ZXN0LnJlc3VsdCk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgfTtcclxuXHJcbiAgICAgIHJlcXVlc3Qub25lcnJvciA9IGZ1bmN0aW9uKGV2ZW50KSB7XHJcbiAgICAgIH1cclxuICAgIH1cclxuXHJcblxyXG4gICAgLy8gUmVxdWVzdCB0byBhcGkgdG8gdXBkYXRlIGluZGV4ZWREQlxyXG4gICAgREJIZWxwZXIuZ2V0UmVzdGF1cmFudEZyb21BcGkodXJsLCBjYWxsYmFjayk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBGZXRjaCBhIHJlc3RhdXJhbnQgYnkgaXRzIElELlxyXG4gICAqL1xyXG4gIHN0YXRpYyBmZXRjaFJldmlld1Jlc3RhdXJhbnRCeUlkKGlkLCBjYWxsYmFjaykge1xyXG5cclxuICAgIHZhciB1cmwgPSBEQkhlbHBlci5SRVZJRVdfVVJMICsgYCR7aWR9YDtcclxuICAgIGlmIChEQkhlbHBlci5kYjIgIT09IHVuZGVmaW5lZCkge1xyXG4gICAgICB2YXIgdHJhbnNhY3Rpb24gPSBEQkhlbHBlci5kYjIudHJhbnNhY3Rpb24oW1wicmV2aWV3c1wiXSk7XHJcbiAgICAgIHZhciBpbmRleCA9IHRyYW5zYWN0aW9uLm9iamVjdFN0b3JlKFwicmV2aWV3c1wiKS5pbmRleChcInJlc3RhdXJhbnRfaWRcIik7XHJcbiAgICAgIHZhciByZXF1ZXN0ID0gaW5kZXguZ2V0QWxsKHBhcnNlSW50KGlkKSk7XHJcblxyXG4gICAgICByZXF1ZXN0Lm9uc3VjY2VzcyA9IGZ1bmN0aW9uKGV2ZW50KSB7XHJcbiAgICAgICAgaWYocmVxdWVzdC5yZXN1bHQgPT09IHVuZGVmaW5lZCl7XHJcbiAgICAgICAgICBjYWxsYmFjayhcIk5vIHJlc3RhdXJhbnQgZm91bmRcIiwgbnVsbCk7XHJcbiAgICAgICAgICAvLyBSZXF1ZXN0IHRvIGFwaSB0byB1cGRhdGUgaW5kZXhlZERCXHJcbiAgICAgICAgICBEQkhlbHBlci5nZXRGcm9tQXBpKHVybCwgY2FsbGJhY2spO1xyXG4gICAgICAgIH1lbHNle1xyXG4gICAgICAgICAgdmFyIGNhY2hlUmV2aWV3cyA9IHJlcXVlc3QucmVzdWx0O1xyXG4gICAgICAgICAgY2FsbGJhY2sobnVsbCwgcmVxdWVzdC5yZXN1bHQpO1xyXG5cclxuICAgICAgICAgIC8vIFJlcXVlc3QgdG8gYXBpIHRvIHVwZGF0ZSBpbmRleGVkREJcclxuICAgICAgICAgIERCSGVscGVyLmdldFJldmlld3NGcm9tQXBpKHVybCwgKGVycm9yLCByZXNwb25zZSkgPT4ge1xyXG5cclxuICAgICAgICAgICAgdmFyIHdvcmtlciA9IG5ldyBXb3JrZXIoXCIuL2pzL3VwZGF0ZXJSZXZpZXdBcGlXb3JrZXIuanNcIik7XHJcbiAgICAgICAgICAgIHZhciBtZXNzYWdlID0gW2NhY2hlUmV2aWV3cywgcmVzcG9uc2VdO1xyXG5cclxuICAgICAgICAgICAgd29ya2VyLnBvc3RNZXNzYWdlKG1lc3NhZ2UpO1xyXG5cclxuICAgICAgICAgICAgaWYoIXJlcXVlc3QucmVzdWx0KVxyXG4gICAgICAgICAgICAgIGNhbGxiYWNrKGVycm9yLHJlc3BvbnNlKTtcclxuICAgICAgICAgIH0pO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgIH07XHJcblxyXG4gICAgICByZXF1ZXN0Lm9uZXJyb3IgPSBmdW5jdGlvbihldmVudCkge1xyXG4gICAgICAgIC8vIFJlcXVlc3QgdG8gYXBpIHRvIHVwZGF0ZSBpbmRleGVkREJcclxuICAgICAgICBEQkhlbHBlci5nZXRSZXZpZXdzRnJvbUFwaSh1cmwsIGNhbGxiYWNrKTtcclxuICAgICAgfVxyXG4gICAgfVxyXG5cclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIFJlc3RhdXJhbnQgcGFnZSBVUkwuXHJcbiAgICovXHJcbiAgc3RhdGljIHVybEZvclJlc3RhdXJhbnQocmVzdGF1cmFudCkge1xyXG4gICAgcmV0dXJuIChgLi9yZXN0YXVyYW50Lmh0bWw/aWQ9JHtyZXN0YXVyYW50LmlkfWApO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogUmVzdGF1cmFudCBpbWFnZSBVUkwuXHJcbiAgICovXHJcbiAgc3RhdGljIGltYWdlVXJsRm9yUmVzdGF1cmFudChyZXN0YXVyYW50KSB7XHJcbiAgICByZXR1cm4gKGAvaW1nLyR7cmVzdGF1cmFudC5waG90b2dyYXBofS5qcGdgKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIE1hcCBtYXJrZXIgZm9yIGEgcmVzdGF1cmFudC5cclxuICAgKi9cclxuICBzdGF0aWMgbWFwTWFya2VyRm9yUmVzdGF1cmFudChyZXN0YXVyYW50LCBtYXApIHtcclxuICAgIGNvbnN0IG1hcmtlciA9IG5ldyBnb29nbGUubWFwcy5NYXJrZXIoe1xyXG4gICAgICBwb3NpdGlvbjogcmVzdGF1cmFudC5sYXRsbmcsXHJcbiAgICAgIHRpdGxlOiByZXN0YXVyYW50Lm5hbWUsXHJcbiAgICAgIHVybDogREJIZWxwZXIudXJsRm9yUmVzdGF1cmFudChyZXN0YXVyYW50KSxcclxuICAgICAgbWFwOiBtYXAsXHJcbiAgICAgIGFuaW1hdGlvbjogZ29vZ2xlLm1hcHMuQW5pbWF0aW9uLkRST1BcclxuICAgIH0pO1xyXG4gICAgcmV0dXJuIG1hcmtlcjtcclxuICB9XHJcblxyXG59IiwibGV0IHJlc3RhdXJhbnQ7XHJcbmxldCByZXZpZXdzO1xyXG52YXIgbWFwO1xyXG5jb25zdCBNQVhfVEVYVF9MRU5HVEggPSA0MDA7XHJcblxyXG4vKipcclxuICogSW5pdGlhbGl6ZSBHb29nbGUgbWFwLCBjYWxsZWQgZnJvbSBIVE1MLlxyXG4gKi9cclxud2luZG93LmluaXRNYXAgPSAoKSA9PiB7XHJcblxyXG4gIHZhciBpbmRleGVkREIgPSB3aW5kb3cuaW5kZXhlZERCIHx8IHdpbmRvdy5tb3pJbmRleGVkREIgfHwgd2luZG93LndlYmtpdEluZGV4ZWREQiB8fCB3aW5kb3cubXNJbmRleGVkREIgfHwgd2luZG93LnNoaW1JbmRleGVkREI7XHJcblxyXG4gIGlmICghd2luZG93LmluZGV4ZWREQikge1xyXG4gICAgd2luZG93LmFsZXJ0KFwiU3UgbmF2ZWdhZG9yIG5vIHNvcG9ydGEgdW5hIHZlcnNpw7NuIGVzdGFibGUgZGUgaW5kZXhlZERCLiBUYWwgeSBjb21vIGxhcyBjYXJhY3RlcsOtc3RpY2FzIG5vIHNlcsOhbiB2YWxpZGFzXCIpO1xyXG5cclxuICAgIGZldGNoUmVzdGF1cmFudEZyb21VUkwoKGVycm9yLCByZXN0YXVyYW50KSA9PiB7XHJcbiAgICAgIGlmIChlcnJvcikgeyAvLyBHb3QgYW4gZXJyb3IhXHJcbiAgICAgICAgY29uc29sZS5lcnJvcihlcnJvcik7XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgc2VsZi5tYXAgPSBuZXcgZ29vZ2xlLm1hcHMuTWFwKGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdtYXAnKSwge1xyXG4gICAgICAgICAgem9vbTogMTYsXHJcbiAgICAgICAgICBjZW50ZXI6IHJlc3RhdXJhbnQubGF0bG5nLFxyXG4gICAgICAgICAgc2Nyb2xsd2hlZWw6IGZhbHNlXHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIGZpbGxCcmVhZGNydW1iKCk7XHJcbiAgICAgICAgREJIZWxwZXIubWFwTWFya2VyRm9yUmVzdGF1cmFudChzZWxmLnJlc3RhdXJhbnQsIHNlbGYubWFwKTtcclxuICAgICAgfVxyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICAvLyBkZWphbW9zIGFiaWVydGEgbnVlc3RyYSBiYXNlIGRlIGRhdG9zXHJcbiAgbGV0IHJlcXVlc3QgPSB3aW5kb3cuaW5kZXhlZERCLm9wZW4oXCJyZXN0YXVyYW50cy1qc29uXCIsIDEpO1xyXG5cclxuICByZXF1ZXN0Lm9uZXJyb3IgPSBmdW5jdGlvbihldmVudCkge1xyXG4gICAgYWxlcnQoXCJXaHkgZGlkbid0IHlvdSBhbGxvdyBteSB3ZWIgYXBwIHRvIHVzZSBJbmRleGVkREI/IVwiKTtcclxuICB9O1xyXG4gIHJlcXVlc3Qub25zdWNjZXNzID0gZnVuY3Rpb24oZXZlbnQpIHtcclxuICAgIERCSGVscGVyLmRiID0gcmVxdWVzdC5yZXN1bHQ7XHJcblxyXG4gICAgZmV0Y2hSZXN0YXVyYW50RnJvbVVSTCgoZXJyb3IsIHJlc3RhdXJhbnQpID0+IHtcclxuICAgICAgaWYgKGVycm9yKSB7IC8vIEdvdCBhbiBlcnJvciFcclxuICAgICAgICBjb25zb2xlLmVycm9yKGVycm9yKTtcclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICBzZWxmLm1hcCA9IG5ldyBnb29nbGUubWFwcy5NYXAoZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ21hcCcpLCB7XHJcbiAgICAgICAgICB6b29tOiAxNixcclxuICAgICAgICAgIGNlbnRlcjogcmVzdGF1cmFudC5sYXRsbmcsXHJcbiAgICAgICAgICBzY3JvbGx3aGVlbDogZmFsc2VcclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgZmlsbEJyZWFkY3J1bWIoKTtcclxuICAgICAgICBEQkhlbHBlci5tYXBNYXJrZXJGb3JSZXN0YXVyYW50KHNlbGYucmVzdGF1cmFudCwgc2VsZi5tYXApO1xyXG4gICAgICB9XHJcbiAgICB9KTtcclxuXHJcbiAgICBEQkhlbHBlci5kYi5vbmVycm9yID0gZnVuY3Rpb24oZXZlbnQpIHtcclxuICAgICAgLy8gR2VuZXJpYyBlcnJvciBoYW5kbGVyIGZvciBhbGwgZXJyb3JzIHRhcmdldGVkIGF0IHRoaXMgZGF0YWJhc2Unc1xyXG4gICAgICAvLyByZXF1ZXN0cyFcclxuICAgICAgYWxlcnQoXCJEYXRhYmFzZSBlcnJvcjogXCIgKyBldmVudC50YXJnZXQuZXJyb3JDb2RlKTtcclxuICAgIH07XHJcbiAgfTtcclxuXHJcbiAgLy8gRXN0ZSBldmVudG8gc29sYW1lbnRlIGVzdMOhIGltcGxlbWVudGFkbyBlbiBuYXZlZ2Fkb3JlcyByZWNpZW50ZXNcclxuICByZXF1ZXN0Lm9udXBncmFkZW5lZWRlZCA9IGZ1bmN0aW9uKGV2ZW50KSB7XHJcbiAgICB2YXIgZGIgPSBldmVudC50YXJnZXQucmVzdWx0O1xyXG5cclxuICAgIC8vIFNlIGNyZWEgdW4gYWxtYWPDqW4gcGFyYSBjb250ZW5lciBsYSBpbmZvcm1hY2nDs24gZGUgbnVlc3Ryb3MgY2xpZW50ZVxyXG4gICAgLy8gU2UgdXNhcsOhIFwic3NuXCIgY29tbyBjbGF2ZSB5YSBxdWUgZXMgZ2FyYW50aXphZG8gcXVlIGVzIMO6bmljYVxyXG4gICAgdmFyIG9iamVjdFN0b3JlID0gZGIuY3JlYXRlT2JqZWN0U3RvcmUoXCJyZXN0YXVyYW50c1wiLCB7XHJcbiAgICAgIGtleVBhdGg6IFwiaWRcIlxyXG4gICAgfSk7XHJcblxyXG4gICAgLy8gU2UgY3JlYSB1biDDrW5kaWNlIHBhcmEgYnVzY2FyIGNsaWVudGVzcG9yIHZlY2luZGFyaW8uLlxyXG4gICAgb2JqZWN0U3RvcmUuY3JlYXRlSW5kZXgoXCJuZWlnaGJvcmhvb2RcIiwgXCJuZWlnaGJvcmhvb2RcIiwge1xyXG4gICAgICB1bmlxdWU6IGZhbHNlXHJcbiAgICB9KTtcclxuXHJcbiAgICAvLyBTZSBjcmVhIHVuIGluZGljZSBwYXJhIGJ1c2NhciBjbGllbnRlcyBwb3IgdGlwbyBkZSBjb2NpbmFcclxuICAgIG9iamVjdFN0b3JlLmNyZWF0ZUluZGV4KFwiY3Vpc2luZV90eXBlXCIsIFwiY3Vpc2luZV90eXBlXCIsIHtcclxuICAgICAgdW5pcXVlOiBmYWxzZVxyXG4gICAgfSk7XHJcblxyXG4gICAgLy8gU2UgY3JlYSB1biDDrW5kaWNlIHBhcmEgYnVzY2FyIGNsaWVudGVzcG9yIHZlY2luZGFyaW8uLlxyXG4gICAgb2JqZWN0U3RvcmUuY3JlYXRlSW5kZXgoXCJuZWlnaGJvcmhvb2QtY3Vpc2luZV90eXBlXCIsIFtcIm5laWdoYm9yaG9vZFwiLCBcImN1aXNpbmVfdHlwZVwiXSwge1xyXG4gICAgICB1bmlxdWU6IGZhbHNlXHJcbiAgICB9KTtcclxuICB9O1xyXG5cclxuICAvLyBkZWphbW9zIGFiaWVydGEgbnVlc3RyYSBiYXNlIGRlIGRhdG9zXHJcbiAgbGV0IHJlcXVlc3QyID0gd2luZG93LmluZGV4ZWREQi5vcGVuKFwicmV2aWV3cy1qc29uXCIsIDEpO1xyXG5cclxuICByZXF1ZXN0Mi5vbmVycm9yID0gZnVuY3Rpb24oZXZlbnQpIHtcclxuICAgIGFsZXJ0KFwiV2h5IGRpZG4ndCB5b3UgYWxsb3cgbXkgd2ViIGFwcCB0byB1c2UgSW5kZXhlZERCPyFcIik7XHJcbiAgfTtcclxuICByZXF1ZXN0Mi5vbnN1Y2Nlc3MgPSBmdW5jdGlvbihldmVudCkge1xyXG4gICAgREJIZWxwZXIuZGIyID0gcmVxdWVzdDIucmVzdWx0O1xyXG5cclxuICAgIGZldGNoUmV2aWV3c0Zyb21VUkwoKTtcclxuXHJcbiAgICBEQkhlbHBlci5kYjIub25lcnJvciA9IGZ1bmN0aW9uKGV2ZW50KSB7XHJcbiAgICAgIC8vIEdlbmVyaWMgZXJyb3IgaGFuZGxlciBmb3IgYWxsIGVycm9ycyB0YXJnZXRlZCBhdCB0aGlzIGRhdGFiYXNlJ3NcclxuICAgICAgLy8gcmVxdWVzdHMhXHJcbiAgICAgIGFsZXJ0KFwiRGF0YWJhc2UgZXJyb3I6IFwiICsgZXZlbnQudGFyZ2V0LmVycm9yQ29kZSk7XHJcbiAgICB9O1xyXG4gIH07XHJcblxyXG4gIC8vIEVzdGUgZXZlbnRvIHNvbGFtZW50ZSBlc3TDoSBpbXBsZW1lbnRhZG8gZW4gbmF2ZWdhZG9yZXMgcmVjaWVudGVzXHJcbiAgcmVxdWVzdDIub251cGdyYWRlbmVlZGVkID0gZnVuY3Rpb24oZXZlbnQpIHtcclxuICAgIHZhciBkYiA9IGV2ZW50LnRhcmdldC5yZXN1bHQ7XHJcblxyXG4gICAgLy8gU2UgY3JlYSB1biBhbG1hY8OpbiBwYXJhIGNvbnRlbmVyIGxhIGluZm9ybWFjacOzbiBkZSBudWVzdHJvcyBjbGllbnRlXHJcbiAgICAvLyBTZSB1c2Fyw6EgXCJzc25cIiBjb21vIGNsYXZlIHlhIHF1ZSBlcyBnYXJhbnRpemFkbyBxdWUgZXMgw7puaWNhXHJcbiAgICB2YXIgb2JqZWN0U3RvcmUgPSBkYi5jcmVhdGVPYmplY3RTdG9yZShcInJldmlld3NcIiwge1xyXG4gICAgICBrZXlQYXRoOiBbXCJyZXN0YXVyYW50X2lkXCIsIFwibmFtZVwiLCBcImNyZWF0ZWRBdFwiLCBcInVwZGF0ZWRBdFwiXVxyXG4gICAgfSk7XHJcblxyXG5cclxuICAgIC8vIFNlIGNyZWEgdW4gw61uZGljZSBwYXJhIGJ1c2NhciBjbGllbnRlc3BvciB2ZWNpbmRhcmlvLi5cclxuICAgIG9iamVjdFN0b3JlLmNyZWF0ZUluZGV4KFwicmVzdGF1cmFudF9pZFwiLCBcInJlc3RhdXJhbnRfaWRcIiwge1xyXG4gICAgICB1bmlxdWU6IGZhbHNlXHJcbiAgICB9KTtcclxuICB9O1xyXG5cclxuICBjb25zdCBmb3JtID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3Jldmlldy1mb3JtJyk7XHJcbiAgZm9ybS5hZGRFdmVudExpc3RlbmVyKFwiY2xpY2tcIixmdW5jdGlvbihlKXtcclxuICAgIGUucHJldmVudERlZmF1bHQoKTtcclxuXHJcbiAgICB2YXIgd29ya2VyID0gbmV3IFdvcmtlcihcIi4vanMvcG9zdFdvcmtlci5qc1wiKTtcclxuXHJcbiAgICB2YXIgdXNlcm5hbWUgPSBkb2N1bWVudC5nZXRFbGVtZW50c0J5TmFtZSgndXNlcm5hbWUnKVswXS52YWx1ZTtcclxuICAgIGRvY3VtZW50LmdldEVsZW1lbnRzQnlOYW1lKCd1c2VybmFtZScpWzBdLnZhbHVlID0gbnVsbDtcclxuXHJcbiAgICB2YXIgcmF0aW5nID0gZG9jdW1lbnQuZ2V0RWxlbWVudHNCeU5hbWUoJ3JhdGluZycpWzBdLnZhbHVlO1xyXG4gICAgZG9jdW1lbnQuZ2V0RWxlbWVudHNCeU5hbWUoJ3JhdGluZycpWzBdLnZhbHVlID0gbnVsbDtcclxuXHJcbiAgICB2YXIgY29tbWVudCA9IGRvY3VtZW50LmdldEVsZW1lbnRzQnlOYW1lKCdjb21tZW50JylbMF0udmFsdWU7XHJcbiAgICBkb2N1bWVudC5nZXRFbGVtZW50c0J5TmFtZSgnY29tbWVudCcpWzBdLnZhbHVlID0gbnVsbDtcclxuXHJcblxyXG4gICAgdmFyIGlkID0gZ2V0UGFyYW1ldGVyQnlOYW1lKCdpZCcpO1xyXG4gICAgdmFyIG1lc3NhZ2UgPSB7XCJyZXN0YXVyYW50X2lkXCI6IHBhcnNlSW50KGlkKSwgXCJuYW1lXCI6IHVzZXJuYW1lLCBcImNyZWF0ZWRBdFwiOiBEYXRlLm5vdygpLCBcInVwZGF0ZWRBdFwiOiBEYXRlLm5vdygpLCBcInJhdGluZ1wiOiByYXRpbmcsIFwiY29tbWVudHNcIjogY29tbWVudCB9O1xyXG5cclxuICAgIHdvcmtlci5wb3N0TWVzc2FnZShtZXNzYWdlKTtcclxuXHJcbiAgICBhZGRSZXZpZXcobWVzc2FnZSk7XHJcblxyXG4gIH0pO1xyXG5cclxuICBcclxuXHJcblxyXG4gIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdzaG93LW1hcC1saW5rJykuYWRkRXZlbnRMaXN0ZW5lcihcImNsaWNrXCIsKGUpID0+IHtcclxuICAgIGUucHJldmVudERlZmF1bHQoKTtcclxuICAgIGlmIChlLnRhcmdldC5pbm5lckhUTUwgPT09IFwiU2hvdyBNYXBcIil7XHJcbiAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdtYXAnKS5zdHlsZS5kaXNwbGF5ID0gXCJibG9ja1wiO1xyXG4gICAgICBlLnRhcmdldC5pbm5lckhUTUwgPSBcIkhpZGRlIE1hcFwiO1xyXG4gICAgfWVsc2V7XHJcbiAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdtYXAnKS5zdHlsZS5kaXNwbGF5ID0gXCJub25lXCI7XHJcbiAgICAgIGUudGFyZ2V0LmlubmVySFRNTCA9IFwiU2hvdyBNYXBcIjtcclxuICAgIH1cclxuICB9KTtcclxufVxyXG5cclxuYWRkUmV2aWV3ID0gKG1lc3NhZ2UpID0+IHtcclxuXHJcbiAgY29uc3QgdWwgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncmV2aWV3cy1saXN0Jyk7XHJcblxyXG4gIHVsLmFwcGVuZENoaWxkKGNyZWF0ZVJldmlld0hUTUwobWVzc2FnZSkpO1xyXG5cclxuICBpZiAoREJIZWxwZXIuZGIyICE9PSB1bmRlZmluZWQpIHtcclxuICAgIHZhciB0cmFuc2FjdGlvbiA9IERCSGVscGVyLmRiMi50cmFuc2FjdGlvbihbXCJyZXZpZXdzXCJdLCBcInJlYWR3cml0ZVwiKTtcclxuICAgIHZhciBvYmplY3RTdG9yZSA9IHRyYW5zYWN0aW9uLm9iamVjdFN0b3JlKFwicmV2aWV3c1wiKTtcclxuXHJcbiAgICB2YXIgcmVxdWVzdCA9IG9iamVjdFN0b3JlLnB1dChtZXNzYWdlKTtcclxuICAgIHJlcXVlc3Qub25lcnJvciA9ICgpID0+IHtcclxuICAgICAgY29uc29sZS5sb2coXCJDb3VsZG50IGJlIGFkZGVkXCIpXHJcbiAgICB9O1xyXG4gIFxyXG4gIH1cclxuXHJcbn1cclxuXHJcbi8qKlxyXG4gKiBHZXQgY3VycmVudCByZXN0YXVyYW50IGZyb20gcGFnZSBVUkwuXHJcbiAqL1xyXG5mZXRjaFJlc3RhdXJhbnRGcm9tVVJMID0gKGNhbGxiYWNrKSA9PiB7XHJcbiAgaWYgKHNlbGYucmVzdGF1cmFudCkgeyAvLyByZXN0YXVyYW50IGFscmVhZHkgZmV0Y2hlZCFcclxuICAgIGNhbGxiYWNrKG51bGwsIHNlbGYucmVzdGF1cmFudCk7XHJcbiAgICByZXR1cm47XHJcbiAgfVxyXG4gIHZhciBpZCA9IGdldFBhcmFtZXRlckJ5TmFtZSgnaWQnKTtcclxuICBpZiAoIWlkKSB7IC8vIG5vIGlkIGZvdW5kIGluIFVSTFxyXG4gICAgZXJyb3IgPSAnTm8gcmVzdGF1cmFudCBpZCBpbiBVUkwnXHJcbiAgICBjYWxsYmFjayhlcnJvciwgbnVsbCk7XHJcbiAgfSBlbHNlIHtcclxuICAgIERCSGVscGVyLmZldGNoUmVzdGF1cmFudEJ5SWQoaWQsIChlcnJvciwgcmVzdGF1cmFudCkgPT4ge1xyXG4gICAgICBzZWxmLnJlc3RhdXJhbnQgPSByZXN0YXVyYW50O1xyXG4gICAgICBpZiAoIXJlc3RhdXJhbnQpIHtcclxuICAgICAgICBjb25zb2xlLmVycm9yKGVycm9yKTtcclxuICAgICAgICByZXR1cm47XHJcbiAgICAgIH1cclxuICAgICAgZmlsbFJlc3RhdXJhbnRIVE1MKCk7XHJcbiAgICAgIGNhbGxiYWNrKG51bGwsIHJlc3RhdXJhbnQpXHJcbiAgICB9KTtcclxuICB9XHJcbn1cclxuXHJcbmZldGNoUmV2aWV3c0Zyb21VUkwgPSAoY2FsbGJhY2spID0+IHtcclxuICBpZiAoc2VsZi5yZXZpZXcpIHsgLy8gcmVzdGF1cmFudCBhbHJlYWR5IGZldGNoZWQhXHJcbiAgICBjYWxsYmFjayhudWxsLCBzZWxmLnJldmlldyk7XHJcbiAgICByZXR1cm47XHJcbiAgfVxyXG4gIHZhciBpZCA9IGdldFBhcmFtZXRlckJ5TmFtZSgnaWQnKTtcclxuICBpZiAoIWlkKSB7IC8vIG5vIGlkIGZvdW5kIGluIFVSTFxyXG4gICAgZXJyb3IgPSAnTm8gcmVzdGF1cmFudCBpZCBpbiBVUkwnXHJcbiAgICBjYWxsYmFjayhlcnJvciwgbnVsbCk7XHJcbiAgfSBlbHNlIHtcclxuICAgIERCSGVscGVyLmZldGNoUmV2aWV3UmVzdGF1cmFudEJ5SWQoaWQsIChlcnJvciwgcmV2aWV3cykgPT4ge1xyXG4gICAgICAgIHNlbGYucmV2aWV3cyA9IHJldmlld3M7XHJcbiAgICAgICAgaWYgKCFyZXZpZXdzKSB7XHJcbiAgICAgICAgICBjb25zb2xlLmVycm9yKGVycm9yKTtcclxuICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgLy8gZmlsbCByZXZpZXdzXHJcbiAgICAgICAgZmlsbFJldmlld3NIVE1MKCk7XHJcbiAgICAgIH0pO1xyXG4gIH1cclxufVxyXG5cclxuLyoqXHJcbiAqIENyZWF0ZSByZXN0YXVyYW50IEhUTUwgYW5kIGFkZCBpdCB0byB0aGUgd2VicGFnZVxyXG4gKi9cclxuZmlsbFJlc3RhdXJhbnRIVE1MID0gKHJlc3RhdXJhbnQgPSBzZWxmLnJlc3RhdXJhbnQpID0+IHtcclxuICBjb25zdCBuYW1lID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3Jlc3RhdXJhbnQtbmFtZScpO1xyXG4gIG5hbWUuaW5uZXJIVE1MID0gcmVzdGF1cmFudC5uYW1lO1xyXG5cclxuICBjb25zdCBhZGRyZXNzID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3Jlc3RhdXJhbnQtYWRkcmVzcycpO1xyXG4gIGFkZHJlc3MuaW5uZXJIVE1MID0gcmVzdGF1cmFudC5hZGRyZXNzO1xyXG5cclxuICBjb25zdCBpbWFnZSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdyZXN0YXVyYW50LWltZycpO1xyXG4gIGltYWdlLmNsYXNzTmFtZSA9ICdyZXN0YXVyYW50LWltZyc7XHJcbiAgaW1hZ2Uuc3JjID0gREJIZWxwZXIuaW1hZ2VVcmxGb3JSZXN0YXVyYW50KHJlc3RhdXJhbnQpO1xyXG4gIGltYWdlLmFsdCA9IHJlc3RhdXJhbnQubmFtZSArICdcXCdzIGltYWdlIHNob3dpbmcgc29tZSBkZWxpY2l1cyAnICsgcmVzdGF1cmFudC5jdWlzaW5lX3R5cGUgKyAnIGZvb2QgY29vY2tlZCBpbiAnICsgcmVzdGF1cmFudC5uZWlnaGJvcmhvb2Q7XHJcblxyXG4gIGNvbnN0IGN1aXNpbmUgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncmVzdGF1cmFudC1jdWlzaW5lJyk7XHJcbiAgY3Vpc2luZS5pbm5lckhUTUwgPSByZXN0YXVyYW50LmN1aXNpbmVfdHlwZTtcclxuXHJcbiAgLy8gZmlsbCBvcGVyYXRpbmcgaG91cnNcclxuICBpZiAocmVzdGF1cmFudC5vcGVyYXRpbmdfaG91cnMpIHtcclxuICAgIGZpbGxSZXN0YXVyYW50SG91cnNIVE1MKCk7XHJcbiAgfVxyXG59XHJcblxyXG4vKipcclxuICogQ3JlYXRlIHJlc3RhdXJhbnQgb3BlcmF0aW5nIGhvdXJzIEhUTUwgdGFibGUgYW5kIGFkZCBpdCB0byB0aGUgd2VicGFnZS5cclxuICovXHJcbmZpbGxSZXN0YXVyYW50SG91cnNIVE1MID0gKG9wZXJhdGluZ0hvdXJzID0gc2VsZi5yZXN0YXVyYW50Lm9wZXJhdGluZ19ob3VycykgPT4ge1xyXG4gIGNvbnN0IGhvdXJzID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3Jlc3RhdXJhbnQtaG91cnMnKTtcclxuICBmb3IgKGxldCBrZXkgaW4gb3BlcmF0aW5nSG91cnMpIHtcclxuICAgIGNvbnN0IHJvdyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3RyJyk7XHJcblxyXG4gICAgY29uc3QgZGF5ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgndGQnKTtcclxuICAgIGRheS5pbm5lckhUTUwgPSBrZXk7XHJcbiAgICByb3cuYXBwZW5kQ2hpbGQoZGF5KTtcclxuXHJcbiAgICBjb25zdCB0aW1lID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgndGQnKTtcclxuICAgIHRpbWUuaW5uZXJIVE1MID0gb3BlcmF0aW5nSG91cnNba2V5XTtcclxuICAgIHJvdy5hcHBlbmRDaGlsZCh0aW1lKTtcclxuXHJcbiAgICBob3Vycy5hcHBlbmRDaGlsZChyb3cpO1xyXG4gIH1cclxufVxyXG5cclxuLyoqXHJcbiAqIENyZWF0ZSBhbGwgcmV2aWV3cyBIVE1MIGFuZCBhZGQgdGhlbSB0byB0aGUgd2VicGFnZS5cclxuICovXHJcbmZpbGxSZXZpZXdzSFRNTCA9IChyZXZpZXdzID0gc2VsZi5yZXZpZXdzKSA9PiB7XHJcbiAgY29uc3QgY29udGFpbmVyID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3Jldmlld3MtY29udGFpbmVyJyk7XHJcblxyXG4gIGlmICghcmV2aWV3cykge1xyXG4gICAgY29uc3Qgbm9SZXZpZXdzID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgncCcpO1xyXG4gICAgbm9SZXZpZXdzLmlubmVySFRNTCA9ICdObyByZXZpZXdzIHlldCEnO1xyXG4gICAgY29udGFpbmVyLmFwcGVuZENoaWxkKG5vUmV2aWV3cyk7XHJcbiAgICByZXR1cm47XHJcbiAgfVxyXG4gIGNvbnN0IHVsID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3Jldmlld3MtbGlzdCcpO1xyXG4gIHJldmlld3MuZm9yRWFjaChyZXZpZXcgPT4ge1xyXG4gICAgdWwuYXBwZW5kQ2hpbGQoY3JlYXRlUmV2aWV3SFRNTChyZXZpZXcpKTtcclxuICB9KTtcclxuICBjb250YWluZXIuYXBwZW5kQ2hpbGQodWwpO1xyXG59XHJcblxyXG4vKipcclxuICogQ3JlYXRlIHJldmlldyBIVE1MIGFuZCBhZGQgaXQgdG8gdGhlIHdlYnBhZ2UuXHJcbiAqL1xyXG5jcmVhdGVSZXZpZXdIVE1MID0gKHJldmlldykgPT4ge1xyXG4gIGNvbnN0IGxpID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnbGknKTtcclxuXHJcbiAgY29uc3QgZGl2TmFtZURhdGUgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTtcclxuICBkaXZOYW1lRGF0ZS5zZXRBdHRyaWJ1dGUoXCJjbGFzc1wiLCBcInRpdGxlLWRhdGUtZGl2IGZsZXgtY29udGFpbmVyXCIpO1xyXG5cclxuICBjb25zdCBuYW1lID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgncCcpO1xyXG4gIG5hbWUuaW5uZXJIVE1MID0gcmV2aWV3Lm5hbWU7XHJcbiAgbmFtZS5zZXRBdHRyaWJ1dGUoXCJjbGFzc1wiLCBcInJldmlldy10aXRsZVwiKTtcclxuICBkaXZOYW1lRGF0ZS5hcHBlbmRDaGlsZChuYW1lKTtcclxuXHJcbiAgY29uc3QgZGF0ZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3AnKTtcclxuICBkYXRlLmlubmVySFRNTCA9IG5ldyBEYXRlKHJldmlldy51cGRhdGVkQXQpLnRvVVRDU3RyaW5nKCk7XHJcbiAgZGF0ZS5zZXRBdHRyaWJ1dGUoXCJjbGFzc1wiLCBcInJldmlldy1kYXRlXCIpO1xyXG4gIGRpdk5hbWVEYXRlLmFwcGVuZENoaWxkKGRhdGUpO1xyXG5cclxuICBsaS5hcHBlbmRDaGlsZChkaXZOYW1lRGF0ZSk7XHJcblxyXG4gIGNvbnN0IGRpdlJhdGluZ0NvbW1lbnRzID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7XHJcbiAgZGl2UmF0aW5nQ29tbWVudHMuc2V0QXR0cmlidXRlKFwiY2xhc3NcIiwgXCJyYXRpbmctY29tbWVudC1kaXZcIik7XHJcblxyXG4gIGNvbnN0IHJhdGluZyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3AnKTtcclxuICByYXRpbmcuaW5uZXJIVE1MID0gYFJhdGluZzogJHtyZXZpZXcucmF0aW5nfWA7XHJcbiAgcmF0aW5nLnNldEF0dHJpYnV0ZShcImNsYXNzXCIsIFwicmV2aWV3LXJhdGluZ1wiKTtcclxuICBkaXZSYXRpbmdDb21tZW50cy5hcHBlbmRDaGlsZChyYXRpbmcpO1xyXG5cclxuICBjb25zdCBjb21tZW50RGl2ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7XHJcbiAgaWYgKHJldmlldy5jb21tZW50cy5sZW5ndGggPiBNQVhfVEVYVF9MRU5HVEgpIHtcclxuICAgIGNvbnN0IHNuaXBldFRleHQgPSByZXZpZXcuY29tbWVudHMuc3Vic3RyaW5nKDAsIE1BWF9URVhUX0xFTkdUSCkgKyBcIi4uLlwiO1xyXG4gICAgY29uc3Qgc25pcGV0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgncCcpO1xyXG4gICAgc25pcGV0LnNldEF0dHJpYnV0ZShcImNsYXNzXCIsIFwicmV2aWV3LXNuaXBldFwiKTtcclxuICAgIHNuaXBldC5pbm5lckhUTUwgPSBzbmlwZXRUZXh0O1xyXG4gICAgY29tbWVudERpdi5hcHBlbmRDaGlsZChzbmlwZXQpO1xyXG4gIH1cclxuXHJcbiAgY29uc3QgY29tbWVudHMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdwJyk7XHJcbiAgY29tbWVudHMuaW5uZXJIVE1MID0gcmV2aWV3LmNvbW1lbnRzO1xyXG4gIGNvbW1lbnRzLnNldEF0dHJpYnV0ZShcImNsYXNzXCIsIFwicmV2aWV3LXRleHRcIik7XHJcbiAgaWYgKHJldmlldy5jb21tZW50cy5sZW5ndGggPiBNQVhfVEVYVF9MRU5HVEgpXHJcbiAgICBjb21tZW50cy5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnO1xyXG4gIGNvbW1lbnREaXYuYXBwZW5kQ2hpbGQoY29tbWVudHMpO1xyXG5cclxuICBpZiAocmV2aWV3LmNvbW1lbnRzLmxlbmd0aCA+IE1BWF9URVhUX0xFTkdUSCkge1xyXG4gICAgY29uc3QgZGlzcGxheUJ1dHRvbiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2J1dHRvbicpO1xyXG4gICAgZGlzcGxheUJ1dHRvbi5pbm5lckhUTUwgPSBcIlNlZSBtb3JlLi4uXCI7XHJcbiAgICBkaXNwbGF5QnV0dG9uLnNldEF0dHJpYnV0ZShcImNsYXNzXCIsIFwiZGlzcGxheS1idXR0b25cIik7XHJcbiAgICBkaXNwbGF5QnV0dG9uLmFkZEV2ZW50TGlzdGVuZXIoXCJjbGlja1wiLCBmdW5jdGlvbigpIHtcclxuICAgICAgaWYgKHRoaXMuaW5uZXJIVE1MID09PSBcIlNlZSBtb3JlLi4uXCIpIHtcclxuICAgICAgICB0aGlzLmlubmVySFRNTCA9IFwiU2VlIGxlc3MuLi5cIjtcclxuICAgICAgICB0aGlzLnByZXZpb3VzRWxlbWVudFNpYmxpbmcuc3R5bGUuZGlzcGxheSA9ICdibG9jayc7XHJcbiAgICAgICAgdGhpcy5wcmV2aW91c0VsZW1lbnRTaWJsaW5nLnByZXZpb3VzRWxlbWVudFNpYmxpbmcuc3R5bGUuZGlzcGxheSA9ICdub25lJztcclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICB0aGlzLmlubmVySFRNTCA9IFwiU2VlIG1vcmUuLi5cIjtcclxuICAgICAgICB0aGlzLnByZXZpb3VzRWxlbWVudFNpYmxpbmcuc3R5bGUuZGlzcGxheSA9ICdub25lJztcclxuICAgICAgICB0aGlzLnByZXZpb3VzRWxlbWVudFNpYmxpbmcucHJldmlvdXNFbGVtZW50U2libGluZy5zdHlsZS5kaXNwbGF5ID0gJ2Jsb2NrJztcclxuICAgICAgfVxyXG4gICAgfSk7XHJcbiAgICBjb21tZW50RGl2LmFwcGVuZENoaWxkKGRpc3BsYXlCdXR0b24pO1xyXG4gIH1cclxuXHJcbiAgZGl2UmF0aW5nQ29tbWVudHMuYXBwZW5kQ2hpbGQoY29tbWVudERpdik7XHJcblxyXG4gIGxpLmFwcGVuZENoaWxkKGRpdlJhdGluZ0NvbW1lbnRzKTtcclxuXHJcbiAgcmV0dXJuIGxpO1xyXG59XHJcblxyXG4vKipcclxuICogQWRkIHJlc3RhdXJhbnQgbmFtZSB0byB0aGUgYnJlYWRjcnVtYiBuYXZpZ2F0aW9uIG1lbnVcclxuICovXHJcbmZpbGxCcmVhZGNydW1iID0gKHJlc3RhdXJhbnQgPSBzZWxmLnJlc3RhdXJhbnQpID0+IHtcclxuICBjb25zdCBicmVhZGNydW1iID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2JyZWFkY3J1bWInKTtcclxuICBjb25zdCBsaSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2xpJyk7XHJcbiAgbGkuaW5uZXJIVE1MID0gcmVzdGF1cmFudC5uYW1lO1xyXG4gIGJyZWFkY3J1bWIuYXBwZW5kQ2hpbGQobGkpO1xyXG59XHJcblxyXG4vKipcclxuICogR2V0IGEgcGFyYW1ldGVyIGJ5IG5hbWUgZnJvbSBwYWdlIFVSTC5cclxuICovXHJcbmdldFBhcmFtZXRlckJ5TmFtZSA9IChuYW1lLCB1cmwpID0+IHtcclxuICBpZiAoIXVybClcclxuICAgIHVybCA9IHdpbmRvdy5sb2NhdGlvbi5ocmVmO1xyXG4gIG5hbWUgPSBuYW1lLnJlcGxhY2UoL1tcXFtcXF1dL2csICdcXFxcJCYnKTtcclxuICBjb25zdCByZWdleCA9IG5ldyBSZWdFeHAoYFs/Jl0ke25hbWV9KD0oW14mI10qKXwmfCN8JClgKSxcclxuICAgIHJlc3VsdHMgPSByZWdleC5leGVjKHVybCk7XHJcbiAgaWYgKCFyZXN1bHRzKVxyXG4gICAgcmV0dXJuIG51bGw7XHJcbiAgaWYgKCFyZXN1bHRzWzJdKVxyXG4gICAgcmV0dXJuICcnO1xyXG4gIHJldHVybiBkZWNvZGVVUklDb21wb25lbnQocmVzdWx0c1syXS5yZXBsYWNlKC9cXCsvZywgJyAnKSk7XHJcbn0iLCJmdW5jdGlvbiByZWdpc3RlclNXKCkgeyAgICBcclxuXHJcbiAgICBpZiAobmF2aWdhdG9yLnNlcnZpY2VXb3JrZXIpIHtcclxuICAgICAgICBuYXZpZ2F0b3Iuc2VydmljZVdvcmtlci5yZWdpc3Rlcignc3cuanMnKS50aGVuKGZ1bmN0aW9uIChyZWcpIHtcclxuICAgICAgICAgICAgaWYgKCFuYXZpZ2F0b3Iuc2VydmljZVdvcmtlci5jb250cm9sbGVyKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIGlmIChyZWcud2FpdGluZykge1xyXG4gICAgICAgICAgICAgICAgdXBkYXRlUmVhZHkocmVnLndhaXRpbmcpO1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICBpZiAocmVnLmluc3RhbGxpbmcpIHtcclxuICAgICAgICAgICAgICAgIHRyYWNrSW5zdGFsbGluZyhyZWcuaW5zdGFsbGluZyk7XHJcbiAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIHJlZy5hZGRFdmVudExpc3RlbmVyKCd1cGRhdGVmb3VuZCcsIGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgICAgIHRyYWNrSW5zdGFsbGluZyhyZWcuaW5zdGFsbGluZyk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICB2YXIgcmVmcmVzaGluZztcclxuICAgICAgICBuYXZpZ2F0b3Iuc2VydmljZVdvcmtlci5hZGRFdmVudExpc3RlbmVyKCdjb250cm9sbGVyY2hhbmdlJywgZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICBpZiAocmVmcmVzaGluZykgcmV0dXJuO1xyXG4gICAgICAgICAgICB3aW5kb3cubG9jYXRpb24ucmVsb2FkKCk7XHJcbiAgICAgICAgICAgIHJlZnJlc2hpbmcgPSB0cnVlO1xyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIFxyXG4gICAgfVxyXG59XHJcblxyXG51cGRhdGVSZWFkeSA9IGZ1bmN0aW9uICh3b3JrZXIpIHtcclxuICAgIHdvcmtlci5wb3N0TWVzc2FnZSh7IGFjdGlvbjogJ3NraXBXYWl0aW5nJyB9KTtcclxufTtcclxuXHJcbnRyYWNrSW5zdGFsbGluZyA9IGZ1bmN0aW9uICh3b3JrZXIpIHtcclxuICAgIHdvcmtlci5hZGRFdmVudExpc3RlbmVyKCdzdGF0ZWNoYW5nZScsIGZ1bmN0aW9uICgpIHtcclxuICAgICAgICBpZiAod29ya2VyLnN0YXRlID09ICdpbnN0YWxsZWQnKSB7XHJcbiAgICAgICAgICAgIHVwZGF0ZVJlYWR5KHdvcmtlcik7XHJcbiAgICAgICAgfVxyXG4gICAgfSk7XHJcbn07Il19
