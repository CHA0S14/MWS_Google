class DBHelper{static get DATABASE_URL(){return"http://localhost:1337/restaurants"}static get REVIEW_URL(){return"http://localhost:1337/reviews/?restaurant_id="}static fetchRestaurants(e){if(void 0!==DBHelper.db){var t=DBHelper.db.transaction(["restaurants"]).objectStore("restaurants").getAll();t.onsuccess=function(r){var n=t.result;fetch(DBHelper.DATABASE_URL).then(e=>e.json()).then(r=>{var a=new Worker("./js/updaterFavApiWorker.js"),o=[n,r];a.postMessage(o),0===t.result.length&&DBHelper.getFromApi(DBHelper.DATABASE_URL,e),e(null,r)})},t.onerror=function(t){DBHelper.getFromApi(DBHelper.DATABASE_URL,e)}}else DBHelper.getFromApi(DBHelper.DATABASE_URL,e)}static getFromApi(e,t){fetch(e).then(e=>e.json()).then(e=>{if(void 0!==DBHelper.db){var r=DBHelper.db.transaction(["restaurants"],"readwrite").objectStore("restaurants");if(Array.isArray(e))for(var n in e){e[n].is_favorite=e[n].is_favorite+"",r.put(e[n]).onerror=(()=>{console.log("Couldnt be added")})}else e.is_favorite=e.is_favorite+"",r.put(e).onerror=(()=>{console.log("Couldnt be added")})}t(null,e)}).catch(e=>{t(`Request failed. ${e}`,null)})}static fetchRestaurantById(e,t){if(void 0!==DBHelper.db){var r=DBHelper.db.transaction(["restaurants"]).objectStore("restaurants").get(e),n=DBHelper.DATABASE_URL+`/${e}`;r.onsuccess=function(e){void 0===r.result?t("No restaurant found",null):t(null,r.result),DBHelper.getFromApi(n,t)},r.onerror=function(e){DBHelper.getFromApi(n,t)}}else DBHelper.getFromApi(n,t)}static fetchRestaurantByCuisine(e,t){if(void 0!==DBHelper.db){var r=DBHelper.db.transaction(["restaurants"]).objectStore("restaurants").index("cuisine_type").getAll(e);r.onsuccess=function(n){t(null,r.result),DBHelper.getFromApi(DBHelper.DATABASE_URL+`?cuisine_type=${e}`,t)},r.onerror=function(r){DBHelper.getFromApi(DBHelper.DATABASE_URL+`?cuisine_type=${e}`,t)}}else DBHelper.getFromApi(DBHelper.DATABASE_URL+`?cuisine_type=${e}`,t)}static fetchRestaurantByNeighborhood(e,t){if(void 0!==DBHelper.db){var r=DBHelper.db.transaction(["restaurants"]).objectStore("restaurants").index("neighborhood").getAll(e);r.onsuccess=function(n){t(null,r.result),DBHelper.getFromApi(DBHelper.DATABASE_URL+`?neighborhood=${e}`,t)},r.onerror=function(r){DBHelper.getFromApi(DBHelper.DATABASE_URL+`?neighborhood=${e}`,t)}}else DBHelper.getFromApi(DBHelper.DATABASE_URL+`?neighborhood=${e}`,t)}static fetchRestaurantByCuisineAndNeighborhood(e,t,r){if("all"===t&&"all"===e)DBHelper.fetchRestaurants(r);else if("all"!==t&&"all"===e)DBHelper.fetchRestaurantByNeighborhood(t,r);else if("all"===t&&"all"!==e)DBHelper.fetchRestaurantByCuisine(e,r);else if(void 0!==DBHelper.db){var n=DBHelper.db.transaction(["restaurants"]).objectStore("restaurants").index("neighborhood-cuisine_type").getAll([t,e]);n.onsuccess=function(a){r(null,n.result),DBHelper.getFromApi(DBHelper.DATABASE_URL+`?neighborhood=${t}&cuisine_type=${e}`,r)},n.onerror=function(n){r("Error fetching restaurant by cuisine and neighborhood",null),DBHelper.getFromApi(DBHelper.DATABASE_URL+`?neighborhood=${t}&cuisine_type=${e}`,r)}}else DBHelper.getFromApi(DBHelper.DATABASE_URL+`?neighborhood=${t}&cuisine_type=${e}`,r)}static fetchNeighborhoods(e){DBHelper.fetchRestaurants((t,r)=>{if(t)e(t,null);else{const t=r.map((e,t)=>r[t].neighborhood),n=t.filter((e,r)=>t.indexOf(e)==r);e(null,n)}})}static fetchCuisines(e){DBHelper.fetchRestaurants((t,r)=>{if(t)e(t,null);else{const t=r.map((e,t)=>r[t].cuisine_type),n=t.filter((e,r)=>t.indexOf(e)==r);e(null,n)}})}static urlForRestaurant(e){return`./restaurant.html?id=${e.id}`}static imageUrlForRestaurant(e){return`/img/${e.photograph}.jpg`}static mapMarkerForRestaurant(e,t){return new google.maps.Marker({position:e.latlng,title:e.name,url:DBHelper.urlForRestaurant(e),map:t,animation:google.maps.Animation.DROP})}}let restaurants,neighborhoods,cuisines;var map,markers=[];function registerSW(){var e;navigator.serviceWorker&&(navigator.serviceWorker.register("sw.js").then(function(e){navigator.serviceWorker.controller&&(e.waiting?updateReady(e.waiting):e.installing?trackInstalling(e.installing):e.addEventListener("updatefound",function(){trackInstalling(e.installing)}))}),navigator.serviceWorker.addEventListener("controllerchange",function(){e||(window.location.reload(),e=!0)}))}document.addEventListener("DOMContentLoaded",e=>{fetchNeighborhoods(),fetchCuisines()}),fetchNeighborhoods=(()=>{DBHelper.fetchNeighborhoods((e,t)=>{e?console.error(e):(self.neighborhoods=t,fillNeighborhoodsHTML())})}),fillNeighborhoodsHTML=((e=self.neighborhoods)=>{const t=document.getElementById("neighborhoods-select");e.forEach(e=>{const r=document.createElement("option");r.innerHTML=e,r.value=e,t.append(r)})}),fetchCuisines=(()=>{DBHelper.fetchCuisines((e,t)=>{e?console.error(e):(self.cuisines=t,fillCuisinesHTML())})}),fillCuisinesHTML=((e=self.cuisines)=>{const t=document.getElementById("cuisines-select");e.forEach(e=>{const r=document.createElement("option");r.innerHTML=e,r.value=e,t.append(r)})}),window.initMap=(()=>{self.map=new google.maps.Map(document.getElementById("map"),{zoom:12,center:{lat:40.722216,lng:-73.987501},scrollwheel:!1});window.indexedDB||window.mozIndexedDB||window.webkitIndexedDB||window.msIndexedDB||window.shimIndexedDB;window.indexedDB||(window.alert("Su navegador no soporta una versión estable de indexedDB. Tal y como las características no serán validas"),updateRestaurants());let e=window.indexedDB.open("restaurants-json",1);e.onerror=function(e){alert("Why didn't you allow my web app to use IndexedDB?!")},e.onsuccess=function(t){DBHelper.db=e.result,updateRestaurants(),registerSW(),DBHelper.db.onerror=function(e){alert("Database error: "+e.target.errorCode)}},e.onupgradeneeded=function(e){var t=e.target.result.createObjectStore("restaurants",{keyPath:"id"});t.createIndex("neighborhood","neighborhood",{unique:!1}),t.createIndex("cuisine_type","cuisine_type",{unique:!1}),t.createIndex("neighborhood-cuisine_type",["neighborhood","cuisine_type"],{unique:!1})},document.getElementById("show-map-link").addEventListener("click",e=>{e.preventDefault(),"Show Map"===e.target.innerHTML?(document.getElementById("map").style.display="block",e.target.innerHTML="Hidde Map"):(document.getElementById("map").style.display="none",e.target.innerHTML="Show Map")})}),updateRestaurants=(()=>{const e=document.getElementById("cuisines-select"),t=document.getElementById("neighborhoods-select"),r=e.selectedIndex,n=t.selectedIndex,a=e[r].value,o=t[n].value;DBHelper.fetchRestaurantByCuisineAndNeighborhood(a,o,(e,t)=>{e?console.error(e):(resetRestaurants(t),fillRestaurantsHTML())})}),resetRestaurants=(e=>{self.restaurants=[],document.getElementById("restaurants-list").innerHTML="",self.markers.forEach(e=>e.setMap(null)),self.markers=[],self.restaurants=e}),fillRestaurantsHTML=((e=self.restaurants)=>{const t=document.getElementById("restaurants-list");e.forEach(e=>{t.append(createRestaurantHTML(e))}),myLazyLoad.update(),addMarkersToMap()}),createRestaurantHTML=(e=>{const t=document.createElement("li"),r=document.createElement("img");r.className="restaurant-img lazy",r.setAttribute("data-src",DBHelper.imageUrlForRestaurant(e)),r.alt=e.name+"'s image",t.append(r);const n=document.createElement("h3");n.innerHTML=e.name,t.append(n);const a=document.createElement("p");a.innerHTML=e.neighborhood,t.append(a);const o=document.createElement("p");o.innerHTML=e.address,t.append(o);const s=document.createElement("a");s.innerHTML="View Details",s.setAttribute("aria-label","Clic to view more information and reviews of "+e.name),s.href=DBHelper.urlForRestaurant(e),t.append(s);const i=document.createElement("a");return i.id=e.id,e.is_favorite&&"false"!==e.is_favorite?i.innerHTML="★":i.innerHTML="☆",i.className="fav",i.href="#",i.addEventListener("click",function(t){t.preventDefault();var r=DBHelper.db.transaction(["restaurants"],"readwrite").objectStore("restaurants"),n=parseInt(i.id);"★"===i.innerHTML?(i.innerHTML="☆",e.is_favorite=!1,r.put(e)):(i.innerHTML="★",e.is_favorite=!0,r.put(e));var a=new Worker("./js/putWorker.js"),o=[n,e.is_favorite];a.postMessage(o)}),n.append(i),t}),addMarkersToMap=((e=self.restaurants)=>{e.forEach(e=>{const t=DBHelper.mapMarkerForRestaurant(e,self.map);google.maps.event.addListener(t,"click",()=>{window.location.href=t.url}),self.markers.push(t)})}),updateReady=function(e){e.postMessage({action:"skipWaiting"})},trackInstalling=function(e){e.addEventListener("statechange",function(){"installed"==e.state&&updateReady(e)})};
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImRiaGVscGVyX21haW4uanMiLCJtYWluLmpzIiwic3dSZWdpc3Rlci5qcyJdLCJuYW1lcyI6WyJEQkhlbHBlciIsIkRBVEFCQVNFX1VSTCIsIlJFVklFV19VUkwiLCJbb2JqZWN0IE9iamVjdF0iLCJjYWxsYmFjayIsInVuZGVmaW5lZCIsImRiIiwicmVxdWVzdCIsInRyYW5zYWN0aW9uIiwib2JqZWN0U3RvcmUiLCJnZXRBbGwiLCJvbnN1Y2Nlc3MiLCJldmVudCIsImNhY2hlUmV2aWV3cyIsInJlc3VsdCIsImZldGNoIiwidGhlbiIsInJlc3BvbnNlIiwianNvbiIsIndvcmtlciIsIldvcmtlciIsIm1lc3NhZ2UiLCJwb3N0TWVzc2FnZSIsImxlbmd0aCIsImdldEZyb21BcGkiLCJvbmVycm9yIiwidXJsIiwiQXJyYXkiLCJpc0FycmF5IiwiaSIsImlzX2Zhdm9yaXRlIiwicHV0IiwiY29uc29sZSIsImxvZyIsImNhdGNoIiwiZSIsImlkIiwiZ2V0IiwiY3Vpc2luZSIsImluZGV4IiwibmVpZ2hib3Job29kIiwiZmV0Y2hSZXN0YXVyYW50cyIsImZldGNoUmVzdGF1cmFudEJ5TmVpZ2hib3Job29kIiwiZmV0Y2hSZXN0YXVyYW50QnlDdWlzaW5lIiwiZXJyb3IiLCJyZXN0YXVyYW50cyIsIm5laWdoYm9yaG9vZHMiLCJtYXAiLCJ2IiwidW5pcXVlTmVpZ2hib3Job29kcyIsImZpbHRlciIsImluZGV4T2YiLCJjdWlzaW5lcyIsImN1aXNpbmVfdHlwZSIsInVuaXF1ZUN1aXNpbmVzIiwicmVzdGF1cmFudCIsInBob3RvZ3JhcGgiLCJnb29nbGUiLCJtYXBzIiwiTWFya2VyIiwicG9zaXRpb24iLCJsYXRsbmciLCJ0aXRsZSIsIm5hbWUiLCJ1cmxGb3JSZXN0YXVyYW50IiwiYW5pbWF0aW9uIiwiQW5pbWF0aW9uIiwiRFJPUCIsIm1hcmtlcnMiLCJyZWdpc3RlclNXIiwicmVmcmVzaGluZyIsIm5hdmlnYXRvciIsInNlcnZpY2VXb3JrZXIiLCJyZWdpc3RlciIsInJlZyIsImNvbnRyb2xsZXIiLCJ3YWl0aW5nIiwidXBkYXRlUmVhZHkiLCJpbnN0YWxsaW5nIiwidHJhY2tJbnN0YWxsaW5nIiwiYWRkRXZlbnRMaXN0ZW5lciIsIndpbmRvdyIsImxvY2F0aW9uIiwicmVsb2FkIiwiZG9jdW1lbnQiLCJmZXRjaE5laWdoYm9yaG9vZHMiLCJmZXRjaEN1aXNpbmVzIiwic2VsZiIsImZpbGxOZWlnaGJvcmhvb2RzSFRNTCIsInNlbGVjdCIsImdldEVsZW1lbnRCeUlkIiwiZm9yRWFjaCIsIm9wdGlvbiIsImNyZWF0ZUVsZW1lbnQiLCJpbm5lckhUTUwiLCJ2YWx1ZSIsImFwcGVuZCIsImZpbGxDdWlzaW5lc0hUTUwiLCJpbml0TWFwIiwiTWFwIiwiem9vbSIsImNlbnRlciIsImxhdCIsImxuZyIsInNjcm9sbHdoZWVsIiwiaW5kZXhlZERCIiwibW96SW5kZXhlZERCIiwid2Via2l0SW5kZXhlZERCIiwibXNJbmRleGVkREIiLCJzaGltSW5kZXhlZERCIiwiYWxlcnQiLCJ1cGRhdGVSZXN0YXVyYW50cyIsIm9wZW4iLCJ0YXJnZXQiLCJlcnJvckNvZGUiLCJvbnVwZ3JhZGVuZWVkZWQiLCJjcmVhdGVPYmplY3RTdG9yZSIsImtleVBhdGgiLCJjcmVhdGVJbmRleCIsInVuaXF1ZSIsInByZXZlbnREZWZhdWx0Iiwic3R5bGUiLCJkaXNwbGF5IiwiY1NlbGVjdCIsIm5TZWxlY3QiLCJjSW5kZXgiLCJzZWxlY3RlZEluZGV4IiwibkluZGV4IiwiZmV0Y2hSZXN0YXVyYW50QnlDdWlzaW5lQW5kTmVpZ2hib3Job29kIiwicmVzZXRSZXN0YXVyYW50cyIsImZpbGxSZXN0YXVyYW50c0hUTUwiLCJtIiwic2V0TWFwIiwidWwiLCJjcmVhdGVSZXN0YXVyYW50SFRNTCIsIm15TGF6eUxvYWQiLCJ1cGRhdGUiLCJhZGRNYXJrZXJzVG9NYXAiLCJsaSIsImltYWdlIiwiY2xhc3NOYW1lIiwic2V0QXR0cmlidXRlIiwiaW1hZ2VVcmxGb3JSZXN0YXVyYW50IiwiYWx0IiwiYWRkcmVzcyIsIm1vcmUiLCJocmVmIiwiZmF2IiwicGFyc2VJbnQiLCJtYXJrZXIiLCJtYXBNYXJrZXJGb3JSZXN0YXVyYW50IiwiYWRkTGlzdGVuZXIiLCJwdXNoIiwiYWN0aW9uIiwic3RhdGUiXSwibWFwcGluZ3MiOiJNQUdBQSxTQUtBQywwQkFFQSxNQUFBLG9DQUVBQyx3QkFFQSxNQUFBLGdEQU1BQyx3QkFBQUMsR0FDQSxRQUFBQyxJQUFBTCxTQUFBTSxHQUFBLENBQ0EsSUFFQUMsRUFGQVAsU0FBQU0sR0FBQUUsYUFBQSxnQkFDQUMsWUFBQSxlQUNBQyxTQUVBSCxFQUFBSSxVQUFBLFNBQUFDLEdBQ0EsSUFBQUMsRUFBQU4sRUFBQU8sT0FFQUMsTUFBQWYsU0FBQUMsY0FDQWUsS0FBQUMsR0FBQUEsRUFBQUMsUUFDQUYsS0FBQUMsSUFHQSxJQUFBRSxFQUFBLElBQUFDLE9BQUEsK0JBQ0FDLEdBQUFSLEVBQUFJLEdBRUFFLEVBQUFHLFlBQUFELEdBRUEsSUFBQWQsRUFBQU8sT0FBQVMsUUFDQXZCLFNBQUF3QixXQUFBeEIsU0FBQUMsYUFBQUcsR0FFQUEsRUFBQSxLQUFBYSxNQUlBVixFQUFBa0IsUUFBQSxTQUFBYixHQUNBWixTQUFBd0IsV0FBQXhCLFNBQUFDLGFBQUFHLFNBR0FKLFNBQUF3QixXQUFBeEIsU0FBQUMsYUFBQUcsR0FLQUQsa0JBQUF1QixFQUFBdEIsR0FDQVcsTUFBQVcsR0FDQVYsS0FBQUMsR0FBQUEsRUFBQUMsUUFDQUYsS0FBQUMsSUFFQSxRQUFBWixJQUFBTCxTQUFBTSxHQUFBLENBQ0EsSUFDQUcsRUFEQVQsU0FBQU0sR0FBQUUsYUFBQSxlQUFBLGFBQ0FDLFlBQUEsZUFFQSxHQUFBa0IsTUFBQUMsUUFBQVgsR0FDQSxJQUFBLElBQUFZLEtBQUFaLEVBQUEsQ0FDQUEsRUFBQVksR0FBQUMsWUFBQWIsRUFBQVksR0FBQUMsWUFBQSxHQUNBckIsRUFBQXNCLElBQUFkLEVBQUFZLElBR0FKLFFBQUEsTUFDQU8sUUFBQUMsSUFBQSwyQkFLQWhCLEVBQUFhLFlBQUFiLEVBQUFh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QyxFQUFBekIsYUFBQSxFQUNBckIsRUFBQXNCLElBQUF3QixLQUdBNEYsRUFBQXJELFVBQUEsSUFDQXZDLEVBQUF6QixhQUFBLEVBQ0FyQixFQUFBc0IsSUFBQXdCLElBR0EsSUFBQXBDLEVBQUEsSUFBQUMsT0FBQSxxQkFFQUMsR0FBQWUsRUFBQW1CLEVBQUF6QixhQUVBWCxFQUFBRyxZQUFBRCxLQUlBMEMsRUFBQWlDLE9BQUFtRCxHQUVBVCxJQU1BRCxnQkFBQSxFQUFBNUYsRUFBQTBDLEtBQUExQyxlQUNBQSxFQUFBOEMsUUFBQXBDLElBRUEsTUFBQThGLEVBQUFySixTQUFBc0osdUJBQUEvRixFQUFBZ0MsS0FBQXhDLEtBQ0FVLE9BQUFDLEtBQUE5QyxNQUFBMkksWUFBQUYsRUFBQSxRQUFBLEtBQ0FwRSxPQUFBQyxTQUFBZ0UsS0FBQUcsRUFBQTNILE1BRUE2RCxLQUFBbkIsUUFBQW9GLEtBQUFILE9DL1BBeEUsWUFBQSxTQUFBMUQsR0FDQUEsRUFBQUcsYUFBQW1JLE9BQUEsaUJBR0ExRSxnQkFBQSxTQUFBNUQsR0FDQUEsRUFBQTZELGlCQUFBLGNBQUEsV0FDQSxhQUFBN0QsRUFBQXVJLE9BQ0E3RSxZQUFBMUQiLCJmaWxlIjoiYWxsX21haW4uanMiLCJzb3VyY2VzQ29udGVudCI6WyIvKiogXHJcbiAqIENvbW1vbiBkYXRhYmFzZSBoZWxwZXIgZnVuY3Rpb25zLlxyXG4gKi9cclxuY2xhc3MgREJIZWxwZXIge1xyXG4gIC8qKlxyXG4gICAqIERhdGFiYXNlIFVSTC5cclxuICAgKiBDaGFuZ2UgdGhpcyB0byByZXN0YXVyYW50cy5qc29uIGZpbGUgbG9jYXRpb24gb24geW91ciBzZXJ2ZXIuXHJcbiAgICovXHJcbiAgc3RhdGljIGdldCBEQVRBQkFTRV9VUkwoKSB7XHJcbiAgICBjb25zdCBwb3J0ID0gMTMzNzsgLy8gQ2hhbmdlIHRoaXMgdG8geW91ciBzZXJ2ZXIgcG9ydFxyXG4gICAgcmV0dXJuIGBodHRwOi8vbG9jYWxob3N0OiR7cG9ydH0vcmVzdGF1cmFudHNgO1xyXG4gIH1cclxuICBzdGF0aWMgZ2V0IFJFVklFV19VUkwoKSB7XHJcbiAgICBjb25zdCBwb3J0ID0gMTMzNzsgLy8gQ2hhbmdlIHRoaXMgdG8geW91ciBzZXJ2ZXIgcG9ydFxyXG4gICAgcmV0dXJuIGBodHRwOi8vbG9jYWxob3N0OiR7cG9ydH0vcmV2aWV3cy8/cmVzdGF1cmFudF9pZD1gO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogRmV0Y2ggYWxsIHJlc3RhdXJhbnRzLlxyXG4gICAqL1xyXG4gIHN0YXRpYyBmZXRjaFJlc3RhdXJhbnRzKGNhbGxiYWNrKSB7XHJcbiAgICBpZiAoREJIZWxwZXIuZGIgIT09IHVuZGVmaW5lZCkge1xyXG4gICAgICB2YXIgdHJhbnNhY3Rpb24gPSBEQkhlbHBlci5kYi50cmFuc2FjdGlvbihbXCJyZXN0YXVyYW50c1wiXSk7XHJcbiAgICAgIHZhciBvYmplY3RTdG9yZSA9IHRyYW5zYWN0aW9uLm9iamVjdFN0b3JlKFwicmVzdGF1cmFudHNcIik7XHJcbiAgICAgIHZhciByZXF1ZXN0ID0gb2JqZWN0U3RvcmUuZ2V0QWxsKCk7XHJcblxyXG4gICAgICByZXF1ZXN0Lm9uc3VjY2VzcyA9IGZ1bmN0aW9uKGV2ZW50KSB7XHJcbiAgICAgICAgdmFyIGNhY2hlUmV2aWV3cyA9IHJlcXVlc3QucmVzdWx0O1xyXG5cclxuICAgICAgICB2YXIgcmVzdGF1cmFudERhdGEgPSBmZXRjaChEQkhlbHBlci5EQVRBQkFTRV9VUkwpXHJcbiAgICAgICAgLnRoZW4oKHJlc3BvbnNlKSA9PiByZXNwb25zZS5qc29uKCkpXHJcbiAgICAgICAgLnRoZW4oKHJlc3BvbnNlKSA9PiB7XHJcblxyXG5cclxuICAgICAgICAgIHZhciB3b3JrZXIgPSBuZXcgV29ya2VyKFwiLi9qcy91cGRhdGVyRmF2QXBpV29ya2VyLmpzXCIpO1xyXG4gICAgICAgICAgdmFyIG1lc3NhZ2UgPSBbY2FjaGVSZXZpZXdzLCByZXNwb25zZV07XHJcblxyXG4gICAgICAgICAgd29ya2VyLnBvc3RNZXNzYWdlKG1lc3NhZ2UpO1xyXG5cclxuICAgICAgICAgIGlmKHJlcXVlc3QucmVzdWx0Lmxlbmd0aCA9PT0gMClcclxuICAgICAgICAgICAgREJIZWxwZXIuZ2V0RnJvbUFwaShEQkhlbHBlci5EQVRBQkFTRV9VUkwsIGNhbGxiYWNrKTtcclxuXHJcbiAgICAgICAgICBjYWxsYmFjayhudWxsLHJlc3BvbnNlKTtcclxuICAgICAgICB9KTtcclxuICAgICAgfTtcclxuXHJcbiAgICAgIHJlcXVlc3Qub25lcnJvciA9IGZ1bmN0aW9uKGV2ZW50KSB7XHJcbiAgICAgICAgREJIZWxwZXIuZ2V0RnJvbUFwaShEQkhlbHBlci5EQVRBQkFTRV9VUkwsIGNhbGxiYWNrKTtcclxuICAgICAgfVxyXG4gICAgfSBlbHNlIHtcclxuICAgICAgREJIZWxwZXIuZ2V0RnJvbUFwaShEQkhlbHBlci5EQVRBQkFTRV9VUkwsIGNhbGxiYWNrKTtcclxuICAgIH1cclxuXHJcbiAgfVxyXG5cclxuICBzdGF0aWMgZ2V0RnJvbUFwaSh1cmwsIGNhbGxiYWNrKSB7XHJcbiAgICB2YXIgcmVzdGF1cmFudERhdGEgPSBmZXRjaCh1cmwpXHJcbiAgICAgIC50aGVuKChyZXNwb25zZSkgPT4gcmVzcG9uc2UuanNvbigpKVxyXG4gICAgICAudGhlbigocmVzcG9uc2UpID0+IHtcclxuXHJcbiAgICAgICAgaWYgKERCSGVscGVyLmRiICE9PSB1bmRlZmluZWQpIHtcclxuICAgICAgICAgIHZhciB0cmFuc2FjdGlvbiA9IERCSGVscGVyLmRiLnRyYW5zYWN0aW9uKFtcInJlc3RhdXJhbnRzXCJdLCBcInJlYWR3cml0ZVwiKTtcclxuICAgICAgICAgIHZhciBvYmplY3RTdG9yZSA9IHRyYW5zYWN0aW9uLm9iamVjdFN0b3JlKFwicmVzdGF1cmFudHNcIik7XHJcblxyXG4gICAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkocmVzcG9uc2UpKSB7XHJcbiAgICAgICAgICAgIGZvciAodmFyIGkgaW4gcmVzcG9uc2UpIHtcclxuICAgICAgICAgICAgICByZXNwb25zZVtpXS5pc19mYXZvcml0ZSA9IHJlc3BvbnNlW2ldLmlzX2Zhdm9yaXRlICsgXCJcIjtcclxuICAgICAgICAgICAgICB2YXIgcmVxdWVzdCA9IG9iamVjdFN0b3JlLnB1dChyZXNwb25zZVtpXSk7XHJcblxyXG5cclxuICAgICAgICAgICAgICByZXF1ZXN0Lm9uZXJyb3IgPSAoKSA9PiB7XHJcbiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhcIkNvdWxkbnQgYmUgYWRkZWRcIilcclxuICAgICAgICAgICAgICB9O1xyXG4gICAgICAgICAgICAgIFxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICByZXNwb25zZS5pc19mYXZvcml0ZSA9IHJlc3BvbnNlLmlzX2Zhdm9yaXRlICsgXCJcIjtcclxuICAgICAgICAgICAgdmFyIHJlcXVlc3QgPSBvYmplY3RTdG9yZS5wdXQocmVzcG9uc2UpO1xyXG5cclxuICAgICAgICAgICAgcmVxdWVzdC5vbmVycm9yID0gKCkgPT4ge1xyXG4gICAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiQ291bGRudCBiZSBhZGRlZFwiKVxyXG4gICAgICAgICAgICB9O1xyXG4gICAgICAgICAgICBcclxuICAgICAgICAgIH1cclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGNhbGxiYWNrKG51bGwsIHJlc3BvbnNlKTtcclxuICAgICAgfSlcclxuICAgICAgLmNhdGNoKChlKSA9PiB7XHJcbiAgICAgICAgY29uc3QgZXJyb3IgPSAoYFJlcXVlc3QgZmFpbGVkLiAke2V9YCk7XHJcbiAgICAgICAgY2FsbGJhY2soZXJyb3IsIG51bGwpO1xyXG4gICAgICB9KTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIEZldGNoIGEgcmVzdGF1cmFudCBieSBpdHMgSUQuXHJcbiAgICovXHJcbiAgc3RhdGljIGZldGNoUmVzdGF1cmFudEJ5SWQoaWQsIGNhbGxiYWNrKSB7XHJcbiAgICBpZiAoREJIZWxwZXIuZGIgIT09IHVuZGVmaW5lZCkge1xyXG4gICAgICB2YXIgdHJhbnNhY3Rpb24gPSBEQkhlbHBlci5kYi50cmFuc2FjdGlvbihbXCJyZXN0YXVyYW50c1wiXSk7XHJcbiAgICAgIHZhciBvYmplY3RTdG9yZSA9IHRyYW5zYWN0aW9uLm9iamVjdFN0b3JlKFwicmVzdGF1cmFudHNcIik7XHJcbiAgICAgIHZhciByZXF1ZXN0ID0gb2JqZWN0U3RvcmUuZ2V0KGlkKTtcclxuICAgICAgdmFyIHVybCA9IERCSGVscGVyLkRBVEFCQVNFX1VSTCArIGAvJHtpZH1gO1xyXG5cclxuICAgICAgcmVxdWVzdC5vbnN1Y2Nlc3MgPSBmdW5jdGlvbihldmVudCkge1xyXG4gICAgICAgIGlmKHJlcXVlc3QucmVzdWx0ID09PSB1bmRlZmluZWQpe1xyXG4gICAgICAgICAgY2FsbGJhY2soXCJObyByZXN0YXVyYW50IGZvdW5kXCIsIG51bGwpO1xyXG4gICAgICAgIH1lbHNle1xyXG4gICAgICAgICAgY2FsbGJhY2sobnVsbCwgcmVxdWVzdC5yZXN1bHQpO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgLy8gUmVxdWVzdCB0byBhcGkgdG8gdXBkYXRlIGluZGV4ZWREQlxyXG4gICAgICAgIERCSGVscGVyLmdldEZyb21BcGkodXJsLCBjYWxsYmFjayk7XHJcbiAgICAgIH07XHJcblxyXG4gICAgICByZXF1ZXN0Lm9uZXJyb3IgPSBmdW5jdGlvbihldmVudCkge1xyXG4gICAgICAgIC8vIFJlcXVlc3QgdG8gYXBpIHRvIHVwZGF0ZSBpbmRleGVkREJcclxuICAgICAgICBEQkhlbHBlci5nZXRGcm9tQXBpKHVybCwgY2FsbGJhY2spO1xyXG4gICAgICB9XHJcbiAgICB9IGVsc2V7XHJcbiAgICAgIC8vIFJlcXVlc3QgdG8gYXBpIHRvIHVwZGF0ZSBpbmRleGVkREJcclxuICAgICAgREJIZWxwZXIuZ2V0RnJvbUFwaSh1cmwsIGNhbGxiYWNrKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIEZldGNoIHJlc3RhdXJhbnRzIGJ5IGEgY3Vpc2luZSB0eXBlIHdpdGggcHJvcGVyIGVycm9yIGhhbmRsaW5nLlxyXG4gICAqL1xyXG4gIHN0YXRpYyBmZXRjaFJlc3RhdXJhbnRCeUN1aXNpbmUoY3Vpc2luZSwgY2FsbGJhY2spIHtcclxuICAgIGlmIChEQkhlbHBlci5kYiAhPT0gdW5kZWZpbmVkKSB7XHJcbiAgICAgIHZhciB0cmFuc2FjdGlvbiA9IERCSGVscGVyLmRiLnRyYW5zYWN0aW9uKFtcInJlc3RhdXJhbnRzXCJdKTtcclxuICAgICAgdmFyIGluZGV4ID0gdHJhbnNhY3Rpb24ub2JqZWN0U3RvcmUoXCJyZXN0YXVyYW50c1wiKS5pbmRleChcImN1aXNpbmVfdHlwZVwiKTtcclxuICAgICAgdmFyIHJlcXVlc3QgPSBpbmRleC5nZXRBbGwoY3Vpc2luZSk7XHJcblxyXG4gICAgICByZXF1ZXN0Lm9uc3VjY2VzcyA9IGZ1bmN0aW9uKGV2ZW50KSB7XHJcbiAgICAgICAgY2FsbGJhY2sobnVsbCwgcmVxdWVzdC5yZXN1bHQpO1xyXG5cclxuICAgICAgICAvLyBSZXF1ZXN0IHRvIGFwaSB0byB1cGRhdGUgaW5kZXhlZERCXHJcbiAgICAgICAgREJIZWxwZXIuZ2V0RnJvbUFwaShEQkhlbHBlci5EQVRBQkFTRV9VUkwgKyBgP2N1aXNpbmVfdHlwZT0ke2N1aXNpbmV9YCwgY2FsbGJhY2spO1xyXG4gICAgICB9O1xyXG5cclxuICAgICAgcmVxdWVzdC5vbmVycm9yID0gZnVuY3Rpb24oZXZlbnQpIHtcclxuICAgICAgICBEQkhlbHBlci5nZXRGcm9tQXBpKERCSGVscGVyLkRBVEFCQVNFX1VSTCArIGA/Y3Vpc2luZV90eXBlPSR7Y3Vpc2luZX1gLCBjYWxsYmFjayk7XHJcbiAgICAgIH1cclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIERCSGVscGVyLmdldEZyb21BcGkoREJIZWxwZXIuREFUQUJBU0VfVVJMICsgYD9jdWlzaW5lX3R5cGU9JHtjdWlzaW5lfWAsIGNhbGxiYWNrKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIEZldGNoIHJlc3RhdXJhbnRzIGJ5IGEgbmVpZ2hib3Job29kIHdpdGggcHJvcGVyIGVycm9yIGhhbmRsaW5nLlxyXG4gICAqL1xyXG4gIHN0YXRpYyBmZXRjaFJlc3RhdXJhbnRCeU5laWdoYm9yaG9vZChuZWlnaGJvcmhvb2QsIGNhbGxiYWNrKSB7XHJcbiAgICBpZiAoREJIZWxwZXIuZGIgIT09IHVuZGVmaW5lZCkge1xyXG4gICAgICB2YXIgdHJhbnNhY3Rpb24gPSBEQkhlbHBlci5kYi50cmFuc2FjdGlvbihbXCJyZXN0YXVyYW50c1wiXSk7XHJcbiAgICAgIHZhciBpbmRleCA9IHRyYW5zYWN0aW9uLm9iamVjdFN0b3JlKFwicmVzdGF1cmFudHNcIikuaW5kZXgoXCJuZWlnaGJvcmhvb2RcIik7XHJcbiAgICAgIHZhciByZXF1ZXN0ID0gaW5kZXguZ2V0QWxsKG5laWdoYm9yaG9vZCk7XHJcblxyXG4gICAgICByZXF1ZXN0Lm9uc3VjY2VzcyA9IGZ1bmN0aW9uKGV2ZW50KSB7XHJcbiAgICAgICAgY2FsbGJhY2sobnVsbCwgcmVxdWVzdC5yZXN1bHQpO1xyXG5cclxuICAgICAgICAvLyBSZXF1ZXN0IHRvIGFwaSB0byB1cGRhdGUgaW5kZXhlZERCXHJcbiAgICAgICAgREJIZWxwZXIuZ2V0RnJvbUFwaShEQkhlbHBlci5EQVRBQkFTRV9VUkwgKyBgP25laWdoYm9yaG9vZD0ke25laWdoYm9yaG9vZH1gLCBjYWxsYmFjayk7XHJcbiAgICAgIH07XHJcblxyXG4gICAgICByZXF1ZXN0Lm9uZXJyb3IgPSBmdW5jdGlvbihldmVudCkge1xyXG4gICAgICAgIERCSGVscGVyLmdldEZyb21BcGkoREJIZWxwZXIuREFUQUJBU0VfVVJMICsgYD9uZWlnaGJvcmhvb2Q9JHtuZWlnaGJvcmhvb2R9YCwgY2FsbGJhY2spO1xyXG4gICAgICB9XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICBEQkhlbHBlci5nZXRGcm9tQXBpKERCSGVscGVyLkRBVEFCQVNFX1VSTCArIGA/bmVpZ2hib3Job29kPSR7bmVpZ2hib3Job29kfWAsIGNhbGxiYWNrKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIEZldGNoIHJlc3RhdXJhbnRzIGJ5IGEgY3Vpc2luZSBhbmQgYSBuZWlnaGJvcmhvb2Qgd2l0aCBwcm9wZXIgZXJyb3IgaGFuZGxpbmcuXHJcbiAgICovXHJcbiAgc3RhdGljIGZldGNoUmVzdGF1cmFudEJ5Q3Vpc2luZUFuZE5laWdoYm9yaG9vZChjdWlzaW5lLCBuZWlnaGJvcmhvb2QsIGNhbGxiYWNrKSB7XHJcblxyXG4gICAgaWYgKG5laWdoYm9yaG9vZCA9PT0gJ2FsbCcgJiYgY3Vpc2luZSA9PT0gJ2FsbCcpIHtcclxuICAgICAgREJIZWxwZXIuZmV0Y2hSZXN0YXVyYW50cyhjYWxsYmFjayk7XHJcbiAgICB9IGVsc2UgaWYgKG5laWdoYm9yaG9vZCAhPT0gJ2FsbCcgJiYgY3Vpc2luZSA9PT0gJ2FsbCcpIHtcclxuICAgICAgREJIZWxwZXIuZmV0Y2hSZXN0YXVyYW50QnlOZWlnaGJvcmhvb2QobmVpZ2hib3Job29kLCBjYWxsYmFjayk7XHJcbiAgICB9IGVsc2UgaWYgKG5laWdoYm9yaG9vZCA9PT0gJ2FsbCcgJiYgY3Vpc2luZSAhPT0gJ2FsbCcpIHtcclxuICAgICAgREJIZWxwZXIuZmV0Y2hSZXN0YXVyYW50QnlDdWlzaW5lKGN1aXNpbmUsIGNhbGxiYWNrKTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIGlmIChEQkhlbHBlci5kYiAhPT0gdW5kZWZpbmVkKSB7XHJcbiAgICAgICAgdmFyIHRyYW5zYWN0aW9uID0gREJIZWxwZXIuZGIudHJhbnNhY3Rpb24oW1wicmVzdGF1cmFudHNcIl0pO1xyXG4gICAgICAgIHZhciBpbmRleCA9IHRyYW5zYWN0aW9uLm9iamVjdFN0b3JlKFwicmVzdGF1cmFudHNcIikuaW5kZXgoXCJuZWlnaGJvcmhvb2QtY3Vpc2luZV90eXBlXCIpO1xyXG4gICAgICAgIHZhciByZXF1ZXN0ID0gaW5kZXguZ2V0QWxsKFtuZWlnaGJvcmhvb2QsIGN1aXNpbmVdKTtcclxuXHJcbiAgICAgICAgcmVxdWVzdC5vbnN1Y2Nlc3MgPSBmdW5jdGlvbihldmVudCkge1xyXG4gICAgICAgICAgY2FsbGJhY2sobnVsbCwgcmVxdWVzdC5yZXN1bHQpO1xyXG5cclxuICAgICAgICAgIC8vIFJlcXVlc3QgdG8gYXBpIHRvIHVwZGF0ZSBpbmRleGVkREJcclxuICAgICAgICAgIERCSGVscGVyLmdldEZyb21BcGkoREJIZWxwZXIuREFUQUJBU0VfVVJMICsgYD9uZWlnaGJvcmhvb2Q9JHtuZWlnaGJvcmhvb2R9JmN1aXNpbmVfdHlwZT0ke2N1aXNpbmV9YCwgY2FsbGJhY2spO1xyXG4gICAgICAgIH07XHJcblxyXG4gICAgICAgIHJlcXVlc3Qub25lcnJvciA9IGZ1bmN0aW9uKGV2ZW50KSB7XHJcbiAgICAgICAgICBjYWxsYmFjayhcIkVycm9yIGZldGNoaW5nIHJlc3RhdXJhbnQgYnkgY3Vpc2luZSBhbmQgbmVpZ2hib3Job29kXCIsIG51bGwpO1xyXG4gICAgICAgICAgREJIZWxwZXIuZ2V0RnJvbUFwaShEQkhlbHBlci5EQVRBQkFTRV9VUkwgKyBgP25laWdoYm9yaG9vZD0ke25laWdoYm9yaG9vZH0mY3Vpc2luZV90eXBlPSR7Y3Vpc2luZX1gLCBjYWxsYmFjayk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICBEQkhlbHBlci5nZXRGcm9tQXBpKERCSGVscGVyLkRBVEFCQVNFX1VSTCArIGA/bmVpZ2hib3Job29kPSR7bmVpZ2hib3Job29kfSZjdWlzaW5lX3R5cGU9JHtjdWlzaW5lfWAsIGNhbGxiYWNrKTtcclxuICAgICAgfVxyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogRmV0Y2ggYWxsIG5laWdoYm9yaG9vZHMgd2l0aCBwcm9wZXIgZXJyb3IgaGFuZGxpbmcuXHJcbiAgICovXHJcbiAgc3RhdGljIGZldGNoTmVpZ2hib3Job29kcyhjYWxsYmFjaykge1xyXG4gICAgLy8gRmV0Y2ggYWxsIHJlc3RhdXJhbnRzXHJcbiAgICBEQkhlbHBlci5mZXRjaFJlc3RhdXJhbnRzKChlcnJvciwgcmVzdGF1cmFudHMpID0+IHtcclxuICAgICAgaWYgKGVycm9yKSB7XHJcbiAgICAgICAgY2FsbGJhY2soZXJyb3IsIG51bGwpO1xyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIC8vIEdldCBhbGwgbmVpZ2hib3Job29kcyBmcm9tIGFsbCByZXN0YXVyYW50c1xyXG4gICAgICAgIGNvbnN0IG5laWdoYm9yaG9vZHMgPSByZXN0YXVyYW50cy5tYXAoKHYsIGkpID0+IHJlc3RhdXJhbnRzW2ldLm5laWdoYm9yaG9vZCk7XHJcbiAgICAgICAgLy8gUmVtb3ZlIGR1cGxpY2F0ZXMgZnJvbSBuZWlnaGJvcmhvb2RzXHJcbiAgICAgICAgY29uc3QgdW5pcXVlTmVpZ2hib3Job29kcyA9IG5laWdoYm9yaG9vZHMuZmlsdGVyKCh2LCBpKSA9PiBuZWlnaGJvcmhvb2RzLmluZGV4T2YodikgPT0gaSk7XHJcbiAgICAgICAgY2FsbGJhY2sobnVsbCwgdW5pcXVlTmVpZ2hib3Job29kcyk7XHJcbiAgICAgIH1cclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogRmV0Y2ggYWxsIGN1aXNpbmVzIHdpdGggcHJvcGVyIGVycm9yIGhhbmRsaW5nLlxyXG4gICAqL1xyXG4gIHN0YXRpYyBmZXRjaEN1aXNpbmVzKGNhbGxiYWNrKSB7XHJcbiAgICAvLyBGZXRjaCBhbGwgcmVzdGF1cmFudHNcclxuICAgIERCSGVscGVyLmZldGNoUmVzdGF1cmFudHMoKGVycm9yLCByZXN0YXVyYW50cykgPT4ge1xyXG4gICAgICBpZiAoZXJyb3IpIHtcclxuICAgICAgICBjYWxsYmFjayhlcnJvciwgbnVsbCk7XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgLy8gR2V0IGFsbCBjdWlzaW5lcyBmcm9tIGFsbCByZXN0YXVyYW50c1xyXG4gICAgICAgIGNvbnN0IGN1aXNpbmVzID0gcmVzdGF1cmFudHMubWFwKCh2LCBpKSA9PiByZXN0YXVyYW50c1tpXS5jdWlzaW5lX3R5cGUpO1xyXG4gICAgICAgIC8vIFJlbW92ZSBkdXBsaWNhdGVzIGZyb20gY3Vpc2luZXNcclxuICAgICAgICBjb25zdCB1bmlxdWVDdWlzaW5lcyA9IGN1aXNpbmVzLmZpbHRlcigodiwgaSkgPT4gY3Vpc2luZXMuaW5kZXhPZih2KSA9PSBpKTtcclxuICAgICAgICBjYWxsYmFjayhudWxsLCB1bmlxdWVDdWlzaW5lcyk7XHJcbiAgICAgIH1cclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogUmVzdGF1cmFudCBwYWdlIFVSTC5cclxuICAgKi9cclxuICBzdGF0aWMgdXJsRm9yUmVzdGF1cmFudChyZXN0YXVyYW50KSB7XHJcbiAgICByZXR1cm4gKGAuL3Jlc3RhdXJhbnQuaHRtbD9pZD0ke3Jlc3RhdXJhbnQuaWR9YCk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBSZXN0YXVyYW50IGltYWdlIFVSTC5cclxuICAgKi9cclxuICBzdGF0aWMgaW1hZ2VVcmxGb3JSZXN0YXVyYW50KHJlc3RhdXJhbnQpIHtcclxuICAgIHJldHVybiAoYC9pbWcvJHtyZXN0YXVyYW50LnBob3RvZ3JhcGh9LmpwZ2ApO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogTWFwIG1hcmtlciBmb3IgYSByZXN0YXVyYW50LlxyXG4gICAqL1xyXG4gIHN0YXRpYyBtYXBNYXJrZXJGb3JSZXN0YXVyYW50KHJlc3RhdXJhbnQsIG1hcCkge1xyXG4gICAgY29uc3QgbWFya2VyID0gbmV3IGdvb2dsZS5tYXBzLk1hcmtlcih7XHJcbiAgICAgIHBvc2l0aW9uOiByZXN0YXVyYW50LmxhdGxuZyxcclxuICAgICAgdGl0bGU6IHJlc3RhdXJhbnQubmFtZSxcclxuICAgICAgdXJsOiBEQkhlbHBlci51cmxGb3JSZXN0YXVyYW50KHJlc3RhdXJhbnQpLFxyXG4gICAgICBtYXA6IG1hcCxcclxuICAgICAgYW5pbWF0aW9uOiBnb29nbGUubWFwcy5BbmltYXRpb24uRFJPUFxyXG4gICAgfSk7XHJcbiAgICByZXR1cm4gbWFya2VyO1xyXG4gIH1cclxuXHJcbn1cclxuIiwibGV0IHJlc3RhdXJhbnRzLFxyXG4gIG5laWdoYm9yaG9vZHMsXHJcbiAgY3Vpc2luZXM7XHJcbnZhciBtYXA7XHJcbnZhciBtYXJrZXJzID0gW107XHJcblxyXG4vKipcclxuICogRmV0Y2ggbmVpZ2hib3Job29kcyBhbmQgY3Vpc2luZXMgYXMgc29vbiBhcyB0aGUgcGFnZSBpcyBsb2FkZWQuXHJcbiAqL1xyXG5kb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCdET01Db250ZW50TG9hZGVkJywgKGV2ZW50KSA9PiB7XHJcblxyXG4gIGZldGNoTmVpZ2hib3Job29kcygpO1xyXG4gIGZldGNoQ3Vpc2luZXMoKTtcclxuXHJcbn0pO1xyXG5cclxuLyoqXHJcbiAqIEZldGNoIGFsbCBuZWlnaGJvcmhvb2RzIGFuZCBzZXQgdGhlaXIgSFRNTC5cclxuICovXHJcbmZldGNoTmVpZ2hib3Job29kcyA9ICgpID0+IHtcclxuICBEQkhlbHBlci5mZXRjaE5laWdoYm9yaG9vZHMoKGVycm9yLCBuZWlnaGJvcmhvb2RzKSA9PiB7XHJcbiAgICBpZiAoZXJyb3IpIHsgLy8gR290IGFuIGVycm9yXHJcbiAgICAgIGNvbnNvbGUuZXJyb3IoZXJyb3IpO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgc2VsZi5uZWlnaGJvcmhvb2RzID0gbmVpZ2hib3Job29kcztcclxuICAgICAgZmlsbE5laWdoYm9yaG9vZHNIVE1MKCk7XHJcbiAgICB9XHJcbiAgfSk7XHJcbn1cclxuXHJcbi8qKlxyXG4gKiBTZXQgbmVpZ2hib3Job29kcyBIVE1MLlxyXG4gKi9cclxuZmlsbE5laWdoYm9yaG9vZHNIVE1MID0gKG5laWdoYm9yaG9vZHMgPSBzZWxmLm5laWdoYm9yaG9vZHMpID0+IHtcclxuICBjb25zdCBzZWxlY3QgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnbmVpZ2hib3Job29kcy1zZWxlY3QnKTtcclxuICBuZWlnaGJvcmhvb2RzLmZvckVhY2gobmVpZ2hib3Job29kID0+IHtcclxuICAgIGNvbnN0IG9wdGlvbiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ29wdGlvbicpO1xyXG4gICAgb3B0aW9uLmlubmVySFRNTCA9IG5laWdoYm9yaG9vZDtcclxuICAgIG9wdGlvbi52YWx1ZSA9IG5laWdoYm9yaG9vZDtcclxuICAgIHNlbGVjdC5hcHBlbmQob3B0aW9uKTtcclxuICB9KTtcclxufVxyXG5cclxuLyoqXHJcbiAqIEZldGNoIGFsbCBjdWlzaW5lcyBhbmQgc2V0IHRoZWlyIEhUTUwuXHJcbiAqL1xyXG5mZXRjaEN1aXNpbmVzID0gKCkgPT4ge1xyXG4gIERCSGVscGVyLmZldGNoQ3Vpc2luZXMoKGVycm9yLCBjdWlzaW5lcykgPT4ge1xyXG4gICAgaWYgKGVycm9yKSB7IC8vIEdvdCBhbiBlcnJvciFcclxuICAgICAgY29uc29sZS5lcnJvcihlcnJvcik7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICBzZWxmLmN1aXNpbmVzID0gY3Vpc2luZXM7XHJcbiAgICAgIGZpbGxDdWlzaW5lc0hUTUwoKTtcclxuICAgIH1cclxuICB9KTtcclxufVxyXG5cclxuLyoqXHJcbiAqIFNldCBjdWlzaW5lcyBIVE1MLlxyXG4gKi9cclxuZmlsbEN1aXNpbmVzSFRNTCA9IChjdWlzaW5lcyA9IHNlbGYuY3Vpc2luZXMpID0+IHtcclxuICBjb25zdCBzZWxlY3QgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnY3Vpc2luZXMtc2VsZWN0Jyk7XHJcblxyXG4gIGN1aXNpbmVzLmZvckVhY2goY3Vpc2luZSA9PiB7XHJcbiAgICBjb25zdCBvcHRpb24gPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdvcHRpb24nKTtcclxuICAgIG9wdGlvbi5pbm5lckhUTUwgPSBjdWlzaW5lO1xyXG4gICAgb3B0aW9uLnZhbHVlID0gY3Vpc2luZTtcclxuICAgIHNlbGVjdC5hcHBlbmQob3B0aW9uKTtcclxuICB9KTtcclxufVxyXG5cclxuLyoqXHJcbiAqIEluaXRpYWxpemUgR29vZ2xlIG1hcCwgY2FsbGVkIGZyb20gSFRNTC5cclxuICovXHJcbndpbmRvdy5pbml0TWFwID0gKCkgPT4ge1xyXG4gIGxldCBsb2MgPSB7XHJcbiAgICBsYXQ6IDQwLjcyMjIxNixcclxuICAgIGxuZzogLTczLjk4NzUwMVxyXG4gIH07XHJcbiAgc2VsZi5tYXAgPSBuZXcgZ29vZ2xlLm1hcHMuTWFwKGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdtYXAnKSwge1xyXG4gICAgem9vbTogMTIsXHJcbiAgICBjZW50ZXI6IGxvYyxcclxuICAgIHNjcm9sbHdoZWVsOiBmYWxzZVxyXG4gIH0pO1xyXG4gIHZhciBpbmRleGVkREIgPSB3aW5kb3cuaW5kZXhlZERCIHx8IHdpbmRvdy5tb3pJbmRleGVkREIgfHwgd2luZG93LndlYmtpdEluZGV4ZWREQiB8fCB3aW5kb3cubXNJbmRleGVkREIgfHwgd2luZG93LnNoaW1JbmRleGVkREI7XHJcblxyXG4gIGlmICghd2luZG93LmluZGV4ZWREQikge1xyXG4gICAgd2luZG93LmFsZXJ0KFwiU3UgbmF2ZWdhZG9yIG5vIHNvcG9ydGEgdW5hIHZlcnNpw7NuIGVzdGFibGUgZGUgaW5kZXhlZERCLiBUYWwgeSBjb21vIGxhcyBjYXJhY3RlcsOtc3RpY2FzIG5vIHNlcsOhbiB2YWxpZGFzXCIpO1xyXG4gICAgdXBkYXRlUmVzdGF1cmFudHMoKTtcclxuICB9XHJcblxyXG4gIC8vIGRlamFtb3MgYWJpZXJ0YSBudWVzdHJhIGJhc2UgZGUgZGF0b3NcclxuICBsZXQgcmVxdWVzdCA9IHdpbmRvdy5pbmRleGVkREIub3BlbihcInJlc3RhdXJhbnRzLWpzb25cIiwgMSk7XHJcblxyXG4gIHJlcXVlc3Qub25lcnJvciA9IGZ1bmN0aW9uKGV2ZW50KSB7XHJcbiAgICBhbGVydChcIldoeSBkaWRuJ3QgeW91IGFsbG93IG15IHdlYiBhcHAgdG8gdXNlIEluZGV4ZWREQj8hXCIpO1xyXG4gIH07XHJcbiAgcmVxdWVzdC5vbnN1Y2Nlc3MgPSBmdW5jdGlvbihldmVudCkge1xyXG4gICAgREJIZWxwZXIuZGIgPSByZXF1ZXN0LnJlc3VsdDtcclxuXHJcbiAgICB1cGRhdGVSZXN0YXVyYW50cygpO1xyXG5cclxuICAgIHJlZ2lzdGVyU1coKTtcclxuXHJcbiAgICBEQkhlbHBlci5kYi5vbmVycm9yID0gZnVuY3Rpb24oZXZlbnQpIHtcclxuICAgICAgLy8gR2VuZXJpYyBlcnJvciBoYW5kbGVyIGZvciBhbGwgZXJyb3JzIHRhcmdldGVkIGF0IHRoaXMgZGF0YWJhc2Unc1xyXG4gICAgICAvLyByZXF1ZXN0cyFcclxuICAgICAgYWxlcnQoXCJEYXRhYmFzZSBlcnJvcjogXCIgKyBldmVudC50YXJnZXQuZXJyb3JDb2RlKTtcclxuICAgIH07XHJcbiAgfTtcclxuXHJcbiAgLy8gRXN0ZSBldmVudG8gc29sYW1lbnRlIGVzdMOhIGltcGxlbWVudGFkbyBlbiBuYXZlZ2Fkb3JlcyByZWNpZW50ZXNcclxuICByZXF1ZXN0Lm9udXBncmFkZW5lZWRlZCA9IGZ1bmN0aW9uKGV2ZW50KSB7XHJcbiAgICB2YXIgZGIgPSBldmVudC50YXJnZXQucmVzdWx0O1xyXG5cclxuICAgIC8vIFNlIGNyZWEgdW4gYWxtYWPDqW4gcGFyYSBjb250ZW5lciBsYSBpbmZvcm1hY2nDs24gZGUgbnVlc3Ryb3MgY2xpZW50ZVxyXG4gICAgLy8gU2UgdXNhcsOhIFwic3NuXCIgY29tbyBjbGF2ZSB5YSBxdWUgZXMgZ2FyYW50aXphZG8gcXVlIGVzIMO6bmljYVxyXG4gICAgdmFyIG9iamVjdFN0b3JlID0gZGIuY3JlYXRlT2JqZWN0U3RvcmUoXCJyZXN0YXVyYW50c1wiLCB7XHJcbiAgICAgIGtleVBhdGg6IFwiaWRcIlxyXG4gICAgfSk7XHJcblxyXG4gICAgLy8gU2UgY3JlYSB1biDDrW5kaWNlIHBhcmEgYnVzY2FyIGNsaWVudGVzcG9yIHZlY2luZGFyaW8uLlxyXG4gICAgb2JqZWN0U3RvcmUuY3JlYXRlSW5kZXgoXCJuZWlnaGJvcmhvb2RcIiwgXCJuZWlnaGJvcmhvb2RcIiwge1xyXG4gICAgICB1bmlxdWU6IGZhbHNlXHJcbiAgICB9KTtcclxuXHJcbiAgICAvLyBTZSBjcmVhIHVuIGluZGljZSBwYXJhIGJ1c2NhciBjbGllbnRlcyBwb3IgdGlwbyBkZSBjb2NpbmFcclxuICAgIG9iamVjdFN0b3JlLmNyZWF0ZUluZGV4KFwiY3Vpc2luZV90eXBlXCIsIFwiY3Vpc2luZV90eXBlXCIsIHtcclxuICAgICAgdW5pcXVlOiBmYWxzZVxyXG4gICAgfSk7XHJcblxyXG4gICAgLy8gU2UgY3JlYSB1biDDrW5kaWNlIHBhcmEgYnVzY2FyIGNsaWVudGVzcG9yIHZlY2luZGFyaW8uLlxyXG4gICAgb2JqZWN0U3RvcmUuY3JlYXRlSW5kZXgoXCJuZWlnaGJvcmhvb2QtY3Vpc2luZV90eXBlXCIsIFtcIm5laWdoYm9yaG9vZFwiLCBcImN1aXNpbmVfdHlwZVwiXSwge1xyXG4gICAgICB1bmlxdWU6IGZhbHNlXHJcbiAgICB9KTtcclxuICB9O1xyXG5cclxuXHJcbiAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3Nob3ctbWFwLWxpbmsnKS5hZGRFdmVudExpc3RlbmVyKFwiY2xpY2tcIiwoZSkgPT4ge1xyXG4gICAgZS5wcmV2ZW50RGVmYXVsdCgpO1xyXG4gICAgaWYgKGUudGFyZ2V0LmlubmVySFRNTCA9PT0gXCJTaG93IE1hcFwiKXtcclxuICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ21hcCcpLnN0eWxlLmRpc3BsYXkgPSBcImJsb2NrXCI7XHJcbiAgICAgIGUudGFyZ2V0LmlubmVySFRNTCA9IFwiSGlkZGUgTWFwXCI7XHJcbiAgICB9ZWxzZXtcclxuICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ21hcCcpLnN0eWxlLmRpc3BsYXkgPSBcIm5vbmVcIjtcclxuICAgICAgZS50YXJnZXQuaW5uZXJIVE1MID0gXCJTaG93IE1hcFwiO1xyXG4gICAgfVxyXG4gIH0pO1xyXG59XHJcblxyXG4vKipcclxuICogVXBkYXRlIHBhZ2UgYW5kIG1hcCBmb3IgY3VycmVudCByZXN0YXVyYW50cy5cclxuICovXHJcbnVwZGF0ZVJlc3RhdXJhbnRzID0gKCkgPT4ge1xyXG4gIGNvbnN0IGNTZWxlY3QgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnY3Vpc2luZXMtc2VsZWN0Jyk7XHJcbiAgY29uc3QgblNlbGVjdCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCduZWlnaGJvcmhvb2RzLXNlbGVjdCcpO1xyXG5cclxuICBjb25zdCBjSW5kZXggPSBjU2VsZWN0LnNlbGVjdGVkSW5kZXg7XHJcbiAgY29uc3QgbkluZGV4ID0gblNlbGVjdC5zZWxlY3RlZEluZGV4O1xyXG5cclxuICBjb25zdCBjdWlzaW5lID0gY1NlbGVjdFtjSW5kZXhdLnZhbHVlO1xyXG4gIGNvbnN0IG5laWdoYm9yaG9vZCA9IG5TZWxlY3RbbkluZGV4XS52YWx1ZTtcclxuXHJcbiAgREJIZWxwZXIuZmV0Y2hSZXN0YXVyYW50QnlDdWlzaW5lQW5kTmVpZ2hib3Job29kKGN1aXNpbmUsIG5laWdoYm9yaG9vZCwgKGVycm9yLCByZXN0YXVyYW50cykgPT4ge1xyXG4gICAgaWYgKGVycm9yKSB7IC8vIEdvdCBhbiBlcnJvciFcclxuICAgICAgY29uc29sZS5lcnJvcihlcnJvcik7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICByZXNldFJlc3RhdXJhbnRzKHJlc3RhdXJhbnRzKTtcclxuICAgICAgZmlsbFJlc3RhdXJhbnRzSFRNTCgpO1xyXG4gICAgfVxyXG4gIH0pO1xyXG59XHJcblxyXG4vKipcclxuICogQ2xlYXIgY3VycmVudCByZXN0YXVyYW50cywgdGhlaXIgSFRNTCBhbmQgcmVtb3ZlIHRoZWlyIG1hcCBtYXJrZXJzLlxyXG4gKi9cclxucmVzZXRSZXN0YXVyYW50cyA9IChyZXN0YXVyYW50cykgPT4ge1xyXG4gIC8vIFJlbW92ZSBhbGwgcmVzdGF1cmFudHNcclxuICBzZWxmLnJlc3RhdXJhbnRzID0gW107XHJcbiAgY29uc3QgdWwgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncmVzdGF1cmFudHMtbGlzdCcpO1xyXG4gIHVsLmlubmVySFRNTCA9ICcnO1xyXG5cclxuICAvLyBSZW1vdmUgYWxsIG1hcCBtYXJrZXJzXHJcbiAgc2VsZi5tYXJrZXJzLmZvckVhY2gobSA9PiBtLnNldE1hcChudWxsKSk7XHJcbiAgc2VsZi5tYXJrZXJzID0gW107XHJcbiAgc2VsZi5yZXN0YXVyYW50cyA9IHJlc3RhdXJhbnRzO1xyXG59XHJcblxyXG4vKipcclxuICogQ3JlYXRlIGFsbCByZXN0YXVyYW50cyBIVE1MIGFuZCBhZGQgdGhlbSB0byB0aGUgd2VicGFnZS5cclxuICovXHJcbmZpbGxSZXN0YXVyYW50c0hUTUwgPSAocmVzdGF1cmFudHMgPSBzZWxmLnJlc3RhdXJhbnRzKSA9PiB7XHJcbiAgY29uc3QgdWwgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncmVzdGF1cmFudHMtbGlzdCcpO1xyXG5cclxuICByZXN0YXVyYW50cy5mb3JFYWNoKHJlc3RhdXJhbnQgPT4ge1xyXG4gICAgdWwuYXBwZW5kKGNyZWF0ZVJlc3RhdXJhbnRIVE1MKHJlc3RhdXJhbnQpKTtcclxuICB9KTtcclxuXHJcbiAgbXlMYXp5TG9hZC51cGRhdGUoKTtcclxuXHJcbiAgYWRkTWFya2Vyc1RvTWFwKCk7XHJcbn1cclxuXHJcbi8qKlxyXG4gKiBDcmVhdGUgcmVzdGF1cmFudCBIVE1MLlxyXG4gKi9cclxuY3JlYXRlUmVzdGF1cmFudEhUTUwgPSAocmVzdGF1cmFudCkgPT4ge1xyXG4gIGNvbnN0IGxpID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnbGknKTtcclxuXHJcbiAgY29uc3QgaW1hZ2UgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdpbWcnKTtcclxuICBpbWFnZS5jbGFzc05hbWUgPSAncmVzdGF1cmFudC1pbWcgbGF6eSc7XHJcbiAgaW1hZ2Uuc2V0QXR0cmlidXRlKFwiZGF0YS1zcmNcIiwgREJIZWxwZXIuaW1hZ2VVcmxGb3JSZXN0YXVyYW50KHJlc3RhdXJhbnQpKTtcclxuICBpbWFnZS5hbHQgPSByZXN0YXVyYW50Lm5hbWUgKyAnXFwncyBpbWFnZSc7XHJcbiAgbGkuYXBwZW5kKGltYWdlKTtcclxuXHJcbiAgY29uc3QgbmFtZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2gzJyk7XHJcbiAgbmFtZS5pbm5lckhUTUwgPSByZXN0YXVyYW50Lm5hbWU7XHJcbiAgbGkuYXBwZW5kKG5hbWUpO1xyXG5cclxuICBjb25zdCBuZWlnaGJvcmhvb2QgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdwJyk7XHJcbiAgbmVpZ2hib3Job29kLmlubmVySFRNTCA9IHJlc3RhdXJhbnQubmVpZ2hib3Job29kO1xyXG4gIGxpLmFwcGVuZChuZWlnaGJvcmhvb2QpO1xyXG5cclxuICBjb25zdCBhZGRyZXNzID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgncCcpO1xyXG4gIGFkZHJlc3MuaW5uZXJIVE1MID0gcmVzdGF1cmFudC5hZGRyZXNzO1xyXG4gIGxpLmFwcGVuZChhZGRyZXNzKTtcclxuXHJcbiAgY29uc3QgbW9yZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2EnKTtcclxuICBtb3JlLmlubmVySFRNTCA9ICdWaWV3IERldGFpbHMnO1xyXG4gIG1vcmUuc2V0QXR0cmlidXRlKCdhcmlhLWxhYmVsJywgXCJDbGljIHRvIHZpZXcgbW9yZSBpbmZvcm1hdGlvbiBhbmQgcmV2aWV3cyBvZiBcIiArIHJlc3RhdXJhbnQubmFtZSk7XHJcbiAgbW9yZS5ocmVmID0gREJIZWxwZXIudXJsRm9yUmVzdGF1cmFudChyZXN0YXVyYW50KTtcclxuICBsaS5hcHBlbmQobW9yZSk7XHJcblxyXG4gIGNvbnN0IGZhdiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2EnKTtcclxuICBmYXYuaWQgPSByZXN0YXVyYW50LmlkO1xyXG5cclxuICBpZiAoIXJlc3RhdXJhbnQuaXNfZmF2b3JpdGUgfHwgcmVzdGF1cmFudC5pc19mYXZvcml0ZT09PVwiZmFsc2VcIil7XHJcbiAgICBmYXYuaW5uZXJIVE1MID0gJ+KYhic7XHJcbiAgfWVsc2V7XHJcbiAgICBmYXYuaW5uZXJIVE1MID0gJ+KYhSc7XHJcbiAgfVxyXG5cclxuXHJcbiAgZmF2LmNsYXNzTmFtZT1cImZhdlwiO1xyXG4gIGZhdi5ocmVmID0gXCIjXCI7XHJcblxyXG4gIGZhdi5hZGRFdmVudExpc3RlbmVyKFwiY2xpY2tcIixmdW5jdGlvbihlKXtcclxuICAgIGUucHJldmVudERlZmF1bHQoKTtcclxuXHJcbiAgICBcclxuICAgIHZhciB0cmFuc2FjdGlvbiA9IERCSGVscGVyLmRiLnRyYW5zYWN0aW9uKFtcInJlc3RhdXJhbnRzXCJdLCBcInJlYWR3cml0ZVwiKTtcclxuICAgIHZhciBvYmplY3RTdG9yZSA9IHRyYW5zYWN0aW9uLm9iamVjdFN0b3JlKFwicmVzdGF1cmFudHNcIik7XHJcbiAgICB2YXIgaWQgPSBwYXJzZUludChmYXYuaWQpO1xyXG5cclxuICAgIGlmIChmYXYuaW5uZXJIVE1MID09PSAn4piFJyl7XHJcbiAgICAgIGZhdi5pbm5lckhUTUwgPSAn4piGJztcclxuICAgICAgcmVzdGF1cmFudC5pc19mYXZvcml0ZSA9IGZhbHNlO1xyXG4gICAgICBvYmplY3RTdG9yZS5wdXQocmVzdGF1cmFudCk7XHJcblxyXG4gICAgfWVsc2V7XHJcbiAgICAgIGZhdi5pbm5lckhUTUwgPSAn4piFJztcclxuICAgICAgcmVzdGF1cmFudC5pc19mYXZvcml0ZSA9IHRydWU7XHJcbiAgICAgIG9iamVjdFN0b3JlLnB1dChyZXN0YXVyYW50KTtcclxuICAgIH1cclxuXHJcbiAgICB2YXIgd29ya2VyID0gbmV3IFdvcmtlcihcIi4vanMvcHV0V29ya2VyLmpzXCIpO1xyXG5cclxuICAgIHZhciBtZXNzYWdlID0gW2lkLCByZXN0YXVyYW50LmlzX2Zhdm9yaXRlXTtcclxuXHJcbiAgICB3b3JrZXIucG9zdE1lc3NhZ2UobWVzc2FnZSk7XHJcbiAgICBcclxuICB9KTtcclxuXHJcbiAgbmFtZS5hcHBlbmQoZmF2KTtcclxuXHJcbiAgcmV0dXJuIGxpO1xyXG59XHJcblxyXG4vKipcclxuICogQWRkIG1hcmtlcnMgZm9yIGN1cnJlbnQgcmVzdGF1cmFudHMgdG8gdGhlIG1hcC5cclxuICovXHJcbmFkZE1hcmtlcnNUb01hcCA9IChyZXN0YXVyYW50cyA9IHNlbGYucmVzdGF1cmFudHMpID0+IHtcclxuICByZXN0YXVyYW50cy5mb3JFYWNoKHJlc3RhdXJhbnQgPT4ge1xyXG4gICAgLy8gQWRkIG1hcmtlciB0byB0aGUgbWFwXHJcbiAgICBjb25zdCBtYXJrZXIgPSBEQkhlbHBlci5tYXBNYXJrZXJGb3JSZXN0YXVyYW50KHJlc3RhdXJhbnQsIHNlbGYubWFwKTtcclxuICAgIGdvb2dsZS5tYXBzLmV2ZW50LmFkZExpc3RlbmVyKG1hcmtlciwgJ2NsaWNrJywgKCkgPT4ge1xyXG4gICAgICB3aW5kb3cubG9jYXRpb24uaHJlZiA9IG1hcmtlci51cmw7XHJcbiAgICB9KTtcclxuICAgIHNlbGYubWFya2Vycy5wdXNoKG1hcmtlcik7XHJcbiAgfSk7XHJcbn0iLCJmdW5jdGlvbiByZWdpc3RlclNXKCkgeyAgICBcclxuXHJcbiAgICBpZiAobmF2aWdhdG9yLnNlcnZpY2VXb3JrZXIpIHtcclxuICAgICAgICBuYXZpZ2F0b3Iuc2VydmljZVdvcmtlci5yZWdpc3Rlcignc3cuanMnKS50aGVuKGZ1bmN0aW9uIChyZWcpIHtcclxuICAgICAgICAgICAgaWYgKCFuYXZpZ2F0b3Iuc2VydmljZVdvcmtlci5jb250cm9sbGVyKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIGlmIChyZWcud2FpdGluZykge1xyXG4gICAgICAgICAgICAgICAgdXBkYXRlUmVhZHkocmVnLndhaXRpbmcpO1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICBpZiAocmVnLmluc3RhbGxpbmcpIHtcclxuICAgICAgICAgICAgICAgIHRyYWNrSW5zdGFsbGluZyhyZWcuaW5zdGFsbGluZyk7XHJcbiAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIHJlZy5hZGRFdmVudExpc3RlbmVyKCd1cGRhdGVmb3VuZCcsIGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgICAgIHRyYWNrSW5zdGFsbGluZyhyZWcuaW5zdGFsbGluZyk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICB2YXIgcmVmcmVzaGluZztcclxuICAgICAgICBuYXZpZ2F0b3Iuc2VydmljZVdvcmtlci5hZGRFdmVudExpc3RlbmVyKCdjb250cm9sbGVyY2hhbmdlJywgZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICBpZiAocmVmcmVzaGluZykgcmV0dXJuO1xyXG4gICAgICAgICAgICB3aW5kb3cubG9jYXRpb24ucmVsb2FkKCk7XHJcbiAgICAgICAgICAgIHJlZnJlc2hpbmcgPSB0cnVlO1xyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIFxyXG4gICAgfVxyXG59XHJcblxyXG51cGRhdGVSZWFkeSA9IGZ1bmN0aW9uICh3b3JrZXIpIHtcclxuICAgIHdvcmtlci5wb3N0TWVzc2FnZSh7IGFjdGlvbjogJ3NraXBXYWl0aW5nJyB9KTtcclxufTtcclxuXHJcbnRyYWNrSW5zdGFsbGluZyA9IGZ1bmN0aW9uICh3b3JrZXIpIHtcclxuICAgIHdvcmtlci5hZGRFdmVudExpc3RlbmVyKCdzdGF0ZWNoYW5nZScsIGZ1bmN0aW9uICgpIHtcclxuICAgICAgICBpZiAod29ya2VyLnN0YXRlID09ICdpbnN0YWxsZWQnKSB7XHJcbiAgICAgICAgICAgIHVwZGF0ZVJlYWR5KHdvcmtlcik7XHJcbiAgICAgICAgfVxyXG4gICAgfSk7XHJcbn07Il19
